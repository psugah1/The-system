<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SYSTEM // QUEST LOG v4</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBoS2-dpbCx9BkHAQLDmskACAbWrMNRYoc",
  authDomain: "the-system-c5d33.firebaseapp.com",
  projectId: "the-system-c5d33",
  storageBucket: "the-system-c5d33.firebasestorage.app",
  messagingSenderId: "599823462747",
  appId: "1:599823462747:web:52d470ed801b6b2c2d6a7e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const USER_ID = 'blthzr'; // your fixed user ID

// Firebase save functions
let fbSaveTimer = null;
let fbLoaded = false; // blocks saves until Firebase data is loaded

function fbSave(collection, key, data){
  if(!fbLoaded) return; // never overwrite Firebase before loading
  db.collection('users').doc(USER_ID).collection(collection).doc(key)
    .set({data: JSON.stringify(data)})
    .catch(e=>console.warn('Firebase save error:',e));
}

function fbSaveImmediate(collection, key, data){
  return db.collection('users').doc(USER_ID).collection(collection).doc(key).set({data: JSON.stringify(data)});
}

async function fbLoad(){
  try {
    const userRef = db.collection('users').doc(USER_ID);
    const [daysDoc, cfgDoc, uiDoc, playerDoc] = await Promise.all([
      userRef.collection('data').doc('days').get(),
      userRef.collection('data').doc('cfg').get(),
      userRef.collection('data').doc('ui').get(),
      userRef.collection('data').doc('player').get(),
    ]);
    return {
      days: daysDoc.exists ? JSON.parse(daysDoc.data().data) : null,
      cfg:  cfgDoc.exists  ? JSON.parse(cfgDoc.data().data)  : null,
      ui:   uiDoc.exists   ? JSON.parse(uiDoc.data().data)   : null,
      player: playerDoc.exists ? playerDoc.data().data : null,
    };
  } catch(e){
    console.warn('Firebase load error:',e);
    return {days:null,cfg:null,ui:null,player:null};
  }
}
</script>
<style>
:root{
  --bg:#010208;--panel:#040a14;--panel2:#060d1a;--border:#0e3060;--border2:#0a2040;
  --blue:#00ccff;--purple:#9966ff;--text:#d8eeff;--dim:#3a6090;--mid:#6090b8;
  --accent:#00e5ff;--danger:#ff3355;--gold:#ffd700;--green:#00ff99;
  --glow:#00e5ff;--glow-strong:rgba(0,229,255,0.9);
  --cat1:#00e5ff;--cat2:#ff6b35;--cat3:#00ff99;--cat4:#cc55ff;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:#010208;color:var(--text);font-family:'Rajdhani',sans-serif;display:flex;flex-direction:column;height:100%;position:relative}

/* vignette over canvas */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:1;
  background:radial-gradient(ellipse 100% 100% at 50% 50%, transparent 45%, rgba(0,0,8,.78) 100%);
}
/* top darkening so header reads clearly */
body::after{
  content:'';position:fixed;top:0;left:0;right:0;height:180px;pointer-events:none;z-index:1;
  background:linear-gradient(to bottom,rgba(1,2,8,.95) 0%,transparent 100%);
}



/* â”€â”€ HEADER â”€â”€ */
.hdr{position:relative;z-index:10;background:rgba(2,6,16,.97);border-bottom:1px solid rgba(0,210,255,.35);box-shadow:0 1px 20px rgba(0,180,255,.15);padding:13px 14px 0;flex-shrink:0}
.hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:4px;min-width:0}
.logo{font-family:'Orbitron',monospace;font-size:16px;font-weight:900;letter-spacing:2px;background:linear-gradient(135deg,#fff 0%,var(--accent) 50%,var(--purple) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-block{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1}
.logo-system{font-family:'Orbitron',monospace;font-size:15px;font-weight:900;letter-spacing:3px;background:linear-gradient(135deg,#fff 0%,var(--accent) 50%,var(--purple) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 6px rgba(0,229,255,.6))}
.logo-player{display:flex;align-items:center;gap:5px}
.player-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--mid)}
.player-name{font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--gold);cursor:pointer;border-bottom:1px dashed rgba(255,215,0,.3);padding-bottom:1px;transition:color .2s}
.player-name:hover{color:#fff}
.player-totalxp{font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--gold);text-shadow:0 0 8px rgba(255,215,0,.6)}

/* â”€â”€ RANK BADGE â”€â”€ */
.rank-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:4px;font-family:'Orbitron',monospace;font-size:13px;font-weight:900;letter-spacing:1px;border:2px solid;flex-shrink:0}
.rank-e{background:rgba(100,100,100,.15);border-color:#666;color:#888;text-shadow:0 0 6px #666}
.rank-d{background:rgba(0,180,100,.1);border-color:#00b464;color:#00d478;text-shadow:0 0 8px #00d478}
.rank-c{background:rgba(0,120,255,.12);border-color:#0088ff;color:#44aaff;text-shadow:0 0 8px #44aaff}
.rank-b{background:rgba(120,0,255,.12);border-color:#8844ff;color:#aa66ff;text-shadow:0 0 8px #aa66ff}
.rank-a{background:rgba(255,50,50,.12);border-color:#ff3333;color:#ff6666;text-shadow:0 0 10px #ff3333}
.rank-s{background:rgba(255,180,0,.15);border-color:#ffaa00;color:#ffd700;text-shadow:0 0 14px #ffaa00,0 0 28px rgba(255,180,0,.5);animation:sRankPulse 2s ease-in-out infinite}
@keyframes sRankPulse{0%,100%{box-shadow:0 0 8px rgba(255,180,0,.3),inset 0 0 8px rgba(255,180,0,.1)}50%{box-shadow:0 0 18px rgba(255,180,0,.7),inset 0 0 14px rgba(255,180,0,.2)}}
.rank-label{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1.5px;color:var(--mid);margin-left:4px}

/* â”€â”€ STATUS WINDOW (add quest panel) â”€â”€ */
.inp-panel{
  background:rgba(2,8,24,.92);
  border:1px solid rgba(0,180,255,.5);
  border-radius:8px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 0 30px rgba(0,150,255,.15),inset 0 0 40px rgba(0,80,180,.06),0 0 0 1px rgba(0,180,255,.08);
  backdrop-filter:blur(4px);
  position:relative;
}
.inp-panel::before{
  content:'[ STATUS WINDOW ]';
  position:absolute;
  top:-9px;left:16px;
  font-family:'Orbitron',monospace;font-size:7px;letter-spacing:3px;
  color:rgba(0,200,255,.7);
  background:rgba(2,8,24,.95);
  padding:0 8px;
}
.inp-panel::after{
  content:'';
  position:absolute;
  inset:0;border-radius:8px;
  background:linear-gradient(135deg,rgba(0,180,255,.04) 0%,transparent 50%,rgba(0,100,255,.03) 100%);
  pointer-events:none;
}
.qi{flex:1;background:rgba(0,170,255,.06);border:1px solid rgba(0,170,255,.3);border-radius:4px;padding:10px 11px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;transition:all .2s;caret-color:var(--accent)}
.qi:focus{border-color:rgba(0,220,255,.7);box-shadow:0 0 12px rgba(0,200,255,.2),inset 0 0 8px rgba(0,150,255,.05)}

/* â”€â”€ SYSTEM NOTIFICATION â”€â”€ */
/* â”€â”€ BOSS SKULL IN BANNER â”€â”€ */
.boss-skull{
  position:absolute;right:16px;top:50%;transform:translateY(-50%);
  font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;
  color:#c040ff;cursor:pointer;
  text-shadow:0 0 10px #c040ff,0 0 20px rgba(160,0,255,.5);
  animation:skullPulse 2s ease-in-out infinite;
  user-select:none;
}
@keyframes skullPulse{
  0%,100%{text-shadow:0 0 8px #c040ff,0 0 16px rgba(160,0,255,.4);opacity:.8}
  50%{text-shadow:0 0 16px #c040ff,0 0 32px rgba(180,0,255,.7),0 0 48px rgba(140,0,220,.3);opacity:1}
}

.notif{position:fixed;top:36px;left:50%;transform:translateX(-50%);z-index:350;pointer-events:none;opacity:0;transition:opacity .25s ease,transform .25s ease;transform:translateX(-50%) translateY(-10px)}
.notif.show{opacity:1;transform:translateX(-50%) translateY(0)}
.notif.hide{opacity:0;transform:translateX(-50%) translateY(-10px)}
.notif-inner{
  display:flex;align-items:center;gap:8px;
  padding:8px 18px;
  background:rgba(2,8,28,.92);
  border:1px solid rgba(0,200,255,.6);
  border-radius:4px;
  font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;
  color:#fff;
  text-shadow:0 0 8px rgba(0,220,255,.8);
  box-shadow:0 0 20px rgba(0,180,255,.25),inset 0 0 20px rgba(0,100,255,.06);
  white-space:nowrap;
  backdrop-filter:blur(4px);
}
.notif-inner::before{content:'â–¶';color:rgba(0,220,255,.8);font-size:7px}

.player-name-input{display:none;font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--gold);background:transparent;border:none;border-bottom:1px solid var(--gold);outline:none;width:100px;padding-bottom:1px}
.date-nav{display:flex;align-items:center;gap:4px;flex-shrink:0}
.dnbtn{background:none;border:1px solid var(--border);color:var(--mid);width:30px;height:30px;border-radius:3px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.dnbtn:active{border-color:var(--accent);color:var(--accent)}
.ddisp{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--accent);text-align:center;min-width:90px;cursor:pointer}
.ddisp .ds{color:var(--dim);font-size:8px;letter-spacing:1px;margin-top:2px}
.stats-row{display:flex;border:1px solid rgba(0,180,255,.2);border-radius:3px;overflow:hidden;margin-bottom:10px;box-shadow:0 0 10px rgba(0,150,255,.06)}
.si{flex:1;padding:5px 0;text-align:center;border-right:1px solid var(--border2)}
.si:last-child{border-right:none}
.sv{font-family:'Orbitron',monospace;font-size:15px;font-weight:700;text-shadow:0 0 10px currentColor}
.sl{font-size:9px;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase}

/* XP BAR */
.xp-bar-wrap{padding:0 0 8px}
.xp-label{display:flex;justify-content:space-between;margin-bottom:4px}
.xp-title{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--mid)}
.xp-val{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px;color:var(--gold)}
.xp-track{height:6px;background:rgba(255,215,0,.08);border-radius:3px;overflow:hidden;border:1px solid rgba(255,215,0,.15)}
.xp-fill{height:100%;background:linear-gradient(90deg,#ffd700,#ffaa00);border-radius:3px;transition:width .6s cubic-bezier(.34,1.56,.64,1);position:relative}
.xp-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:4px;background:rgba(255,255,255,.6);border-radius:2px;animation:xpShine 1.5s ease-in-out infinite}
@keyframes xpShine{0%,100%{opacity:.3}50%{opacity:1}}

/* â”€â”€ TABS â”€â”€ */
.tabs-bar{position:relative;z-index:10;background:rgba(2,6,16,.97);border-bottom:1px solid rgba(0,210,255,.25);display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
.tabs-bar::-webkit-scrollbar{display:none}
.tbtn{flex-shrink:0;padding:9px 13px;background:none;border:none;border-bottom:2px solid transparent;color:var(--mid);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1.5px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tbtn.active{color:var(--accent);border-bottom-color:var(--accent);text-shadow:0 0 12px rgba(0,229,255,.8)}
.tspc{flex:1;min-width:8px}
.vtog{display:flex;gap:0;border-left:1px solid var(--border);flex-shrink:0}
.vbtn{padding:9px 12px;background:none;border:none;color:var(--dim);font-size:15px;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent}
.vbtn.active{color:var(--accent);border-bottom-color:var(--accent)}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;position:relative;z-index:1;padding:10px 12px 90px}
.main::-webkit-scrollbar{width:3px}
.main::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€ INPUT PANEL â”€â”€ */
/* inp-panel moved to status window section */
.inp-row{display:flex;gap:7px;margin-bottom:8px}
/* qi moved to status window section */
.qi::placeholder{color:var(--dim);font-size:14px}
.qi:focus{border-color:var(--accent);background:rgba(0,200,255,.08);box-shadow:0 0 15px rgba(0,229,255,.2)}
.badd{background:linear-gradient(135deg,rgba(0,200,255,.15),rgba(136,85,255,.15));border:1px solid var(--accent);color:var(--accent);font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:1px;padding:10px 13px;border-radius:3px;cursor:pointer;transition:all .2s;white-space:nowrap;box-shadow:0 0 12px rgba(0,229,255,.25),inset 0 0 8px rgba(0,180,255,.08);text-shadow:0 0 8px rgba(0,229,255,.8)}
.badd:active{background:var(--accent);color:var(--bg);transform:scale(.97)}
.inp-opts{display:flex;flex-direction:column;gap:6px;margin-top:2px}
.opts-row{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.opts-label{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px;color:var(--dim);flex-shrink:0;width:52px}
.opts-divider{border:none;border-top:1px solid var(--border);margin:2px 0}
.obtn{flex:1;min-width:0;padding:6px 3px;border-radius:3px;border:1px solid rgba(0,150,255,.2);background:transparent;color:var(--mid);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:.5px;cursor:pointer;transition:all .2s;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pri-btn{flex:1;padding:7px 4px;border-radius:3px;border:1px solid transparent;font-family:'Orbitron',monospace;font-size:8px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all .2s;text-align:center;opacity:.45}
.pri-btn.active{opacity:1;color:#fff}
.pri-btn.pn{background:rgba(0,170,255,.15);border-color:rgba(0,170,255,.4);color:var(--blue)}
.pri-btn.pn.active{background:rgba(0,170,255,.35);border-color:var(--blue)}
.pri-btn.ph{background:rgba(255,170,0,.15);border-color:rgba(255,170,0,.4);color:#ffaa00}
.pri-btn.ph.active{background:rgba(255,170,0,.3);border-color:#ffaa00}
.pri-btn.pu{background:rgba(255,51,85,.15);border-color:rgba(255,51,85,.4);color:var(--danger)}
.pri-btn.pu.active{background:rgba(255,51,85,.35);border-color:var(--danger)}

/* â”€â”€ CATEGORY INLINE ADD â”€â”€ */
.cat-add-row{display:flex;gap:6px;padding:6px 0 2px;border-top:1px solid var(--border2);margin-top:4px}
.cat-add-input{flex:1;background:rgba(0,170,255,.04);border:1px solid rgba(0,170,255,.15);border-radius:3px;padding:8px 10px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;caret-color:var(--accent)}
.cat-add-input::placeholder{color:var(--dim);font-size:13px}
.cat-add-input:focus{border-color:var(--accent)}
.cat-add-btn{background:none;border:1px solid rgba(0,170,255,.3);color:var(--accent);font-family:'Orbitron',monospace;font-size:9px;padding:8px 10px;border-radius:3px;cursor:pointer;white-space:nowrap}
.cat-add-btn:active{background:rgba(0,170,255,.15)}
.cat-pri-sel{display:flex;gap:4px}
.cpbtn{padding:6px 8px;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--dim);font-family:'Orbitron',monospace;font-size:7px;letter-spacing:.5px;cursor:pointer;transition:all .15s}
.cpbtn.sel-n{border-color:var(--blue);color:var(--blue);background:rgba(0,170,255,.1)}
.cpbtn.sel-h{border-color:#ffaa00;color:#ffaa00;background:rgba(255,170,0,.1)}
.cpbtn.sel-u{border-color:var(--danger);color:var(--danger);background:rgba(255,51,85,.1)}

/* â”€â”€ CATEGORY SECTION â”€â”€ */
.cat-sec{margin-bottom:16px}
.cat-hdr{display:flex;align-items:center;gap:9px;margin-bottom:7px;padding:4px 4px;cursor:pointer;user-select:none}
.cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cat-title{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;font-weight:700;text-shadow:0 0 10px currentColor}
.cat-line{flex:1;height:1px;opacity:.2}
.cat-cnt{font-family:'Orbitron',monospace;font-size:9px;color:var(--dim);letter-spacing:1px}
.cat-chev{color:var(--dim);font-size:11px;transition:transform .2s}
.cat-sec.collapsed .cat-chev{transform:rotate(-90deg)}
.cat-sec.collapsed .cat-body{display:none}

/* â”€â”€ CAT XP BAR â”€â”€ */
.cat-xp-wrap{margin-bottom:7px}
.cat-xp-track{height:4px;background:rgba(255,215,0,.06);border-radius:2px;overflow:hidden;position:relative}
.cat-xp-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ffaa00);border-radius:2px;transition:width .5s ease}

/* â”€â”€ QUEST ITEM â”€â”€ */
.q-wrap{margin-bottom:6px}
.qi-row{display:flex;align-items:stretch;gap:0;background:rgba(4,10,22,.95);border:1px solid var(--cat-border, rgba(0,180,255,.3));border-radius:4px;position:relative;overflow:visible;transition:border-color .3s,box-shadow .3s;min-height:46px;box-shadow:var(--cat-shadow, 0 0 10px rgba(0,150,255,.1)),inset 0 0 20px var(--cat-inner, rgba(0,100,200,.04))}

/* priority visuals */
.qi-row.pri-hard{border-color:rgba(255,170,0,.55);animation:hardPulse 3s ease-in-out infinite}
.qi-row.pri-hard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#ffaa00;border-radius:3px 0 0 3px;animation:hardBarGlow 3s ease-in-out infinite}
.qi-row.pri-urgent{border-color:rgba(255,51,85,.5);animation:urgentPulse 2s ease-in-out infinite}
.qi-row.pri-urgent::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--danger);border-radius:3px 0 0 3px;animation:urgentBarGlow 2s ease-in-out infinite}

@keyframes hardPulse{
  0%,100%{box-shadow:0 0 5px rgba(255,170,0,.15),inset 0 0 12px rgba(255,150,0,.03);border-color:rgba(255,170,0,.45)}
  50%{box-shadow:0 0 14px 2px rgba(255,170,0,.3),inset 0 0 18px rgba(255,150,0,.06);border-color:rgba(255,170,0,.8)}
}
@keyframes hardBarGlow{
  0%,100%{box-shadow:none;opacity:1}
  50%{box-shadow:0 0 6px 1px rgba(255,170,0,.5);opacity:.85}
}
@keyframes urgentPulse{
  0%,100%{box-shadow:0 0 6px rgba(255,51,85,.2),inset 0 0 15px rgba(255,51,85,.03);border-color:rgba(255,51,85,.5)}
  50%{box-shadow:0 0 20px 4px rgba(255,51,85,.4),inset 0 0 20px rgba(255,51,85,.08);border-color:rgba(255,51,85,.9)}
}
@keyframes urgentBarGlow{
  0%,100%{box-shadow:none;opacity:1}
  50%{box-shadow:0 0 8px 2px rgba(255,51,85,.6);opacity:.8}
}
/* â”€â”€ URGENT SUBTASK GLOW â”€â”€ */
.sub-item.sub-urgent{
  border-color:rgba(255,51,85,.6) !important;
  background:rgba(255,51,85,.07) !important;
  animation:subUrgentPulse 2s ease-in-out infinite !important;
}
@keyframes subUrgentPulse{
  0%  {border-color:rgba(255,51,85,.4) !important;box-shadow:0 0 4px rgba(255,51,85,.2),inset 0 0 6px rgba(255,51,85,.05)}
  50% {border-color:rgba(255,51,85,1) !important; box-shadow:0 0 14px 3px rgba(255,51,85,.6),inset 0 0 14px rgba(255,51,85,.15)}
  100%{border-color:rgba(255,51,85,.4) !important;box-shadow:0 0 4px rgba(255,51,85,.2),inset 0 0 6px rgba(255,51,85,.05)}
}

/* â”€â”€ BOSS PRIORITY â”€â”€ */
.pri-btn.pb{background:rgba(160,0,255,.15);border-color:rgba(160,0,255,.4);color:#c040ff}
.pri-btn.pb.active{background:rgba(160,0,255,.3);border-color:#c040ff}
.cpbtn.sel-b{border-color:#c040ff;color:#c040ff;background:rgba(160,0,255,.1)}
.pri-inline-b{color:#c040ff;background:rgba(160,0,255,.1);border:1px solid rgba(160,0,255,.3)}

/* â”€â”€ BOSS TASK PULSE â”€â”€ */
@keyframes bossPurplePulse{
  0%,100%{box-shadow:0 0 5px 1px rgba(150,0,255,.5)}
  50%{box-shadow:0 0 18px 6px rgba(180,0,255,.9)}
}
@-webkit-keyframes bossPurplePulse{
  0%,100%{box-shadow:0 0 5px 1px rgba(150,0,255,.5)}
  50%{box-shadow:0 0 18px 6px rgba(180,0,255,.9)}
}
@keyframes bossBarGlow{
  0%,100%{box-shadow:0 0 6px rgba(160,0,255,.3)}
  50%{box-shadow:0 0 14px 2px rgba(160,0,255,.7)}
}
.sub-item.sub-boss{
  border-color:rgba(160,0,255,.7) !important;
  background:rgba(40,0,100,.12) !important;
  animation:bossPurplePulse 2s ease-in-out infinite !important;
}

.qi-row.normal::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
/* category colour on normal handled via JS inline style on ::before workaround â€” use a class attribute */
.qi-row[data-cat="DAILY"]{--cline:var(--cat1)}
.qi-row[data-cat="EXERCISE"]{--cline:var(--cat2)}
.qi-row[data-cat="STAY SHREDDED"]{--cline:var(--cat3)}
.qi-row[data-cat="3D CARVING"]{--cline:var(--cat4)}
.qi-row.normal::before{background:var(--cline,var(--accent))}

.qi-row.done{opacity:.4}
.qi-row.dragging{opacity:.25;z-index:200}
.qi-row.drop-target{border-color:var(--accent) !important;box-shadow:0 0 0 1px var(--accent)}

/* priority inline labels */
.pri-inline{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1px;padding:2px 5px;border-radius:2px;margin-left:6px;vertical-align:middle;white-space:nowrap;flex-shrink:0}
.pri-inline-u{color:var(--danger);background:rgba(255,51,85,.1);border:1px solid rgba(255,51,85,.3)}
.pri-inline-h{color:#ffaa00;background:rgba(255,170,0,.1);border:1px solid rgba(255,170,0,.3)}

/* drag handle */
.dh{cursor:grab;color:var(--dim);font-size:15px;flex-shrink:0;padding:0 6px;display:flex;align-items:center;letter-spacing:-2px;user-select:none;border-right:1px solid var(--border2)}
.dh-solo{cursor:grab;color:var(--dim);font-size:10px;flex-shrink:0;padding:0 4px;display:flex;align-items:center;user-select:none;border-right:1px solid var(--border2);letter-spacing:0;opacity:.7;font-family:'Orbitron',monospace}
.dh:active,.dh-solo:active{cursor:grabbing;color:var(--accent)}
.sub-item.sub-nest-target{outline:2px solid var(--green)!important;background:rgba(0,255,136,.07)!important;border-radius:3px}
.qi-row.sub-nest-target{outline:2px solid var(--green)!important;background:rgba(0,255,136,.05)!important}
.dh:active{cursor:grabbing;color:var(--accent)}

/* check */
.qchk{width:22px;height:22px;border:2px solid var(--dim);border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;transition:all .2s;margin:auto 8px}
.qi-row.done .qchk{background:var(--green);border-color:var(--green)}
.chkmark{color:var(--bg);font-size:11px;font-weight:900;opacity:0;transform:scale(0);transition:all .2s}
.qi-row.done .chkmark{opacity:1;transform:scale(1)}

/* text */
.qtw{flex:1;min-width:0;padding:10px 4px;display:flex;flex-direction:column;justify-content:center}
.qtxt{font-size:15px;font-weight:600;word-break:break-word;transition:all .3s;line-height:1.2;color:var(--text)}
.qi-row.done .qtxt{text-decoration:line-through;color:var(--dim)}
.qedit{width:100%;background:transparent;border:none;border-bottom:1px solid var(--accent);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:600;outline:none;caret-color:var(--accent);padding:2px 0}

/* actions */
.qacts{display:flex;gap:3px;align-items:center;padding-right:8px;flex-shrink:0;position:relative}
.qacts-overflow{display:flex;gap:3px;align-items:center;position:absolute;right:30px;top:50%;transform:translateY(-50%);background:rgba(2,8,24,.97);border:1px solid rgba(0,180,255,.25);border-radius:4px;padding:3px 5px;z-index:50;opacity:0;pointer-events:none;transition:opacity .15s;white-space:nowrap}
.qacts-overflow.open{opacity:1;pointer-events:all}
.qbtn-more{border-color:rgba(0,180,255,.25);color:var(--mid);letter-spacing:1px;font-size:10px;width:26px}
.qbtn-more:active,.qbtn-more.open{border-color:rgba(0,180,255,.6);color:var(--accent);background:rgba(0,180,255,.1)}
.qbtn{width:26px;height:26px;border-radius:3px;border:1px solid transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;background:transparent;transition:all .2s}
.qbtn-edit{border-color:rgba(0,170,255,.25);color:var(--blue)}
.qbtn-edit:active{background:rgba(0,170,255,.2)}
.qbtn-lock{border-color:rgba(255,215,0,.15);color:var(--dim);font-size:13px}
.qbtn-lock.locked{border-color:rgba(255,215,0,.5);background:rgba(255,215,0,.08)}
.qbtn-lock:active{background:rgba(255,215,0,.15)}
.qbtn-sub{border-color:rgba(0,255,136,.3);color:var(--green);font-size:16px;font-weight:700;line-height:1}
.qbtn-sub:active{background:rgba(0,255,136,.15)}
.qbtn-dupe{border-color:rgba(0,212,255,.2);color:var(--accent)}
.qbtn-dupe:active{background:rgba(0,212,255,.15)}
.sub-dupe-btn{background:none;border:1px solid rgba(0,212,255,.2);color:var(--accent);width:22px;height:22px;border-radius:2px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.sub-dupe-btn:active{background:rgba(0,212,255,.15)}
.sub-acts{display:flex;gap:2px;align-items:center;flex-shrink:0;position:relative}
.sub-overflow{display:flex;gap:2px;align-items:center;position:absolute;right:24px;top:50%;transform:translateY(-50%);background:rgba(2,8,24,.97);border:1px solid rgba(0,180,255,.25);border-radius:3px;padding:2px 4px;z-index:50;opacity:0;pointer-events:none;transition:opacity .15s;white-space:nowrap}
.sub-overflow.open{opacity:1;pointer-events:all}
.sub-more-btn{background:none;border:1px solid rgba(0,180,255,.2);color:var(--dim);width:22px;height:22px;border-radius:2px;cursor:pointer;font-size:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;letter-spacing:1px}
.sub-more-btn.open{border-color:rgba(0,180,255,.6);color:var(--accent)}
.sub-lock-icon{font-size:10px;margin-left:4px;cursor:default;animation:subLockGlow 2s ease-in-out infinite}
@keyframes subLockGlow{
  0%,100%{filter:drop-shadow(0 0 3px rgba(255,215,0,.6));opacity:.8}
  50%{filter:drop-shadow(0 0 8px rgba(255,215,0,1));opacity:1}
}
.sub-recur-btn{background:none;border:1px solid rgba(255,215,0,.2);color:var(--dim);width:22px;height:22px;border-radius:2px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sub-recur-btn.active{border-color:rgba(255,215,0,.7);color:#ffd700;background:rgba(255,215,0,.1)}
.qbtn-del{border-color:rgba(255,51,85,.5);color:var(--danger);background:rgba(255,51,85,.08);font-size:13px;font-weight:700}
.qbtn-del:active{background:rgba(255,51,85,.25)}
.sub-del{background:none;border:1px solid rgba(255,51,85,.4);color:var(--danger);cursor:pointer;font-size:11px;padding:2px 5px;border-radius:2px;transition:all .15s;font-weight:700}
.sub-del:active{background:rgba(255,51,85,.2)}
.qbtn-save{border-color:rgba(0,255,136,.25);color:var(--green)}
.qbtn-save:active{background:rgba(0,255,136,.2)}

/* â”€â”€ SUBTASKS â”€â”€ */
.sub-wrap{margin-left:18px;margin-top:3px;padding-left:8px;border-left:2px solid var(--border)}
.sub-hdr{display:flex;align-items:center;gap:6px;padding:5px 2px;cursor:pointer;user-select:none;margin-bottom:3px}
.sub-hdr-icon{color:var(--dim);font-size:9px}
.sub-hdr-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--dim)}
.sub-hdr-count{font-family:'Orbitron',monospace;font-size:8px;color:var(--gold);margin-left:auto}
.sub-hdr:hover .sub-hdr-label{color:var(--accent)}
.sub-list{display:flex;flex-direction:column;gap:3px}
.subsub-wrap{margin-left:12px;margin-top:4px;padding-left:8px;border-left:2px solid rgba(136,85,255,.3)}
.subsub-hdr{margin-top:2px}
.subsub-add{margin-left:0}
.sub-dh{cursor:grab;color:var(--dim);font-size:13px;padding:0 4px;letter-spacing:-2px;user-select:none;flex-shrink:0}
.sub-dh:active{cursor:grabbing;color:var(--accent)}
.sub-item{display:flex;align-items:center;gap:7px;padding:6px 8px;background:rgba(4,12,28,.85);border:1px solid rgba(0,160,255,.18);border-radius:3px;margin-bottom:3px;transition:opacity .3s;position:relative}
.sub-item.done{opacity:.4}
.sub-chk{width:16px;height:16px;border:1.5px solid var(--dim);border-radius:2px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;transition:all .15s;font-size:9px;font-weight:900;color:var(--bg)}
.sub-item.done .sub-chk{background:var(--green);border-color:var(--green)}
.sub-txt{flex:1;font-size:13px;font-weight:600;color:var(--mid);transition:all .3s}
.sub-item.done .sub-txt{text-decoration:line-through;color:var(--dim)}
.sub-edit-btn{background:none;border:1px solid rgba(0,170,255,.2);color:var(--blue);width:22px;height:22px;border-radius:2px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.sub-edit-btn:active{background:rgba(0,170,255,.2)}
.sub-save-btn{background:none;border:1px solid rgba(0,255,136,.3);color:var(--green);width:22px;height:22px;border-radius:2px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sub-edit-inp{flex:1;background:rgba(0,170,255,.05);border:none;border-bottom:1px solid var(--accent);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;caret-color:var(--accent);padding:2px 0}
.sub-del:active{background:rgba(255,51,85,.2)}
.sub-add-row{display:flex;gap:6px;margin-top:4px;padding:4px 0}
.sub-add-inp{flex:1;background:rgba(0,0,0,.3);border:1px dashed rgba(0,170,255,.2);border-radius:3px;padding:6px 9px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;caret-color:var(--accent)}
.sub-add-inp::placeholder{color:var(--dim);font-size:12px}
.sub-add-inp:focus{border-color:var(--accent);border-style:solid}
.sub-add-btn{background:none;border:1px solid rgba(255,215,0,.3);color:var(--gold);font-size:11px;padding:6px 9px;border-radius:3px;cursor:pointer;font-family:'Orbitron',monospace;letter-spacing:1px;font-size:9px}

/* â”€â”€ COMPLETE FLASH â”€â”€ */
.complete-overlay{display:none}

/* â”€â”€ COLLAPSE ALL BTN â”€â”€ */
.collapse-all-btn{display:block;width:100%;margin-top:8px;padding:7px;background:transparent;border:1px solid rgba(0,180,255,.15);border-radius:4px;color:rgba(0,180,255,.4);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-align:center}
.collapse-all-btn:hover{border-color:rgba(0,180,255,.4);color:rgba(0,180,255,.7)}

/* â”€â”€ SYSTEM TITLE BANNER â”€â”€ */
.system-banner{position:relative;z-index:10;overflow:hidden;height:36px;background:rgba(0,5,15,.98);border-bottom:1px solid rgba(0,220,255,.2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.system-banner-canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
.system-banner-title{position:relative;z-index:2;font-family:'Orbitron',monospace;font-size:13px;font-weight:900;letter-spacing:6px;color:#fff;text-shadow:0 0 10px rgba(0,229,255,.9),0 0 20px rgba(0,180,255,.5);pointer-events:none}
/* notif moved to system notification section */

/* â”€â”€ OVERVIEW GRID â”€â”€ */
.ov-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ov-card{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.ov-hdr{padding:8px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border2)}
.ov-title{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1.5px;font-weight:700}
.ov-cnt{font-family:'Orbitron',monospace;font-size:12px;font-weight:700}
.ov-body{padding:8px 10px}
.mini-q{display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--border2);cursor:pointer}
.mini-q:last-child{border-bottom:none}
.mini-chk{width:13px;height:13px;border:1.5px solid var(--dim);border-radius:2px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:8px;transition:all .15s}
.mini-q.done .mini-chk{background:var(--green);border-color:var(--green);color:var(--bg)}
.mini-txt{font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mini-q.done .mini-txt{text-decoration:line-through;color:var(--dim)}
.mini-more{font-family:'Orbitron',monospace;font-size:8px;color:var(--dim);padding:4px 0;letter-spacing:1px}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:20;background:rgba(2,6,16,.97);border-top:1px solid rgba(0,200,255,.3);box-shadow:0 -1px 20px rgba(0,150,255,.12);display:flex;height:56px}
.nbtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;color:var(--mid);cursor:pointer;transition:all .2s;font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1px;padding-bottom:env(safe-area-inset-bottom,0px)}
.nbtn .ni{font-size:17px}
.nbtn.active{color:var(--accent);text-shadow:0 0 12px rgba(0,229,255,.9)}
#navU{color:rgba(255,215,0,.5)}
#navU:active{color:var(--gold)}
#navU.has-undo{color:var(--gold)}
#navR{color:rgba(0,255,136,.4)}
#navR:active{color:var(--green)}
#navR.has-redo{color:var(--green)}

/* â”€â”€ MODALS â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:50;display:none;align-items:flex-end;justify-content:center}
.mo.open{display:flex}
.md{background:var(--panel2);border:1px solid var(--border);border-radius:8px 8px 0 0;padding:20px 18px 40px;width:100%;max-width:480px;animation:slideUp .25s ease-out}
@keyframes slideUp{from{transform:translateY(60px);opacity:0}to{transform:translateY(0);opacity:1}}
.md-title{font-family:'Orbitron',monospace;font-size:12px;letter-spacing:2px;color:var(--accent);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.cal-nav-row{display:flex;align-items:center;justify-content:space-between}
.cal-mo{font-family:'Orbitron',monospace;font-size:12px;color:var(--text);letter-spacing:1px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}
.cdh{font-family:'Orbitron',monospace;font-size:8px;color:var(--dim);text-align:center;padding:4px 0;letter-spacing:1px}
.cd{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:3px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;position:relative}
.cd.today{border-color:var(--accent);color:var(--accent)}
.cd.selected{background:var(--accent);color:var(--bg);font-weight:700}
.cd.has-data::after{content:'';position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--green)}
.cd.other{color:var(--dim);opacity:.4}
.cd.future-date{opacity:.5}
.close-md{background:none;border:1px solid var(--border);color:var(--dim);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:10px;border-radius:3px;cursor:pointer;width:100%;margin-top:14px;text-align:center}
.cl-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border2)}
.cl-swatch{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.cl-name{flex:1;font-size:15px;font-weight:600}
.cl-name-inp{flex:1;font-size:14px;font-weight:600;background:transparent;border:none;border-bottom:1px solid rgba(0,180,255,.3);outline:none;padding:2px 0;color:var(--text);width:100%;min-width:0}
.cl-name-inp:focus{border-bottom-color:var(--accent);color:var(--accent)}
.cl-rem{background:none;border:1px solid rgba(255,51,85,.3);color:var(--danger);width:28px;height:28px;border-radius:3px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.nc-row{display:flex;gap:7px;margin-top:12px}
.nc-inp{flex:1;background:rgba(0,170,255,.05);border:1px solid rgba(0,170,255,.2);border-radius:3px;padding:10px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:600;outline:none;caret-color:var(--accent)}
.nc-add{background:linear-gradient(135deg,rgba(0,170,255,.2),rgba(136,85,255,.2));border:1px solid var(--accent);color:var(--accent);font-family:'Orbitron',monospace;font-size:9px;padding:10px 12px;border-radius:3px;cursor:pointer}
.cp-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.cpsw{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s}
.cpsw.picked{border-color:#fff;transform:scale(1.2)}
.cp-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--dim);width:100%;margin-bottom:4px}


.lflash{position:fixed;inset:0;background:rgba(0,170,255,.06);pointer-events:none;opacity:0;z-index:100;transition:opacity .1s}
.lflash.show{opacity:1}

/* â”€â”€ GLOBAL GLOW PASS â”€â”€ */
/* Accent coloured elements emit light */
.ddisp,.cat-cnt,.xp-title,.xp-val,.hist-date{text-shadow:0 0 10px currentColor}
/* Quest text slightly lit */
.qtxt{text-shadow:0 0 6px rgba(200,230,255,.15)}
/* Borders on panels emit subtle light */
.inp-panel,.sub-wrap,.hist-card{box-shadow:0 0 12px rgba(0,160,255,.06),inset 0 0 30px rgba(0,80,180,.03)}
.qi-row:hover{border-color:rgba(0,200,255,.55)!important;box-shadow:0 0 20px rgba(0,180,255,.2),inset 0 0 20px rgba(0,100,200,.06)!important}
/* Sub wrap glowing left edge */
.sub-wrap{border-left:2px solid rgba(0,180,255,.3);box-shadow:0 0 10px rgba(0,150,255,.06)}

/* empty */
.empty{text-align:center;padding:20px;color:var(--dim)}
.empty .ei{font-size:30px;opacity:.2;margin-bottom:8px}
.empty p{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px}

/* history */
.hist-card{background:var(--panel);border:1px solid var(--border);border-radius:4px;margin-bottom:8px;cursor:pointer;overflow:hidden}
.hist-top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border2)}
.hist-date{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:1.5px;color:var(--accent)}
.hist-sub{font-size:11px;color:var(--dim);letter-spacing:1px;margin-top:2px}
.hist-pct{font-family:'Orbitron',monospace;font-size:16px;font-weight:700}
.hist-cnt{font-size:10px;color:var(--dim)}

/* drop zone for cross-cat */
.drop-zone{border:2px dashed rgba(0,212,255,.3);border-radius:4px;padding:8px;text-align:center;font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--dim);margin-bottom:4px;transition:all .2s;display:none}
.drop-zone.active-drop{display:block}
.drop-zone.over{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,.05)}
</style>
</head>
<body>

<canvas id="bgCanvas" style="position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;"></canvas>
<div class="lflash" id="lflash"></div>
<div class="notif" id="notif"><div class="notif-inner" id="notifInner"></div></div>
<div class="complete-overlay" id="cOverlay"></div>

<!-- SYSTEM TITLE BANNER -->
<div class="system-banner">
  <canvas class="system-banner-canvas" id="bannerCanvas"></canvas>
  <div class="system-banner-title">THE SYSTEM</div>
  <div class="boss-skull" id="bossSkull" title="Active boss raids" onclick="showBossRaids()" style="display:none">ðŸ’€ <span id="bossSkullCount">0</span></div>
</div>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-top">
    <div class="logo-block">
      <div class="logo-player">
        <span class="player-label">PLAYER:</span>
        <span class="player-name" id="playerName" onclick="startEditName()">â€”</span>
        <input class="player-name-input" id="playerNameInput" maxlength="20" placeholder="ENTER NAME" onblur="savePlayerName()" onkeydown="if(event.key==='Enter')savePlayerName()"/>
        <span class="player-label" style="margin-left:8px">XP:</span>
        <span class="player-totalxp" id="playerTotalXP">0</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:5px">
        <span class="rank-label">RANK</span>
        <div class="rank-badge rank-e" id="rankBadge">E</div>
        <span class="rank-label" id="rankNextXP" style="margin-left:2px"></span>
        <span class="rank-label" style="margin-left:10px">STREAK</span>
        <span class="player-totalxp" id="streakVal" style="color:#ff6600;text-shadow:0 0 8px rgba(255,100,0,.6)">â€”</span>
      </div>
    </div>
    <div class="date-nav">
      <button class="dnbtn" id="btnPrev" onclick="shiftDay(-1)">â€¹</button>
      <div class="ddisp" onclick="openCal()">
        <div id="dateMain">â€”</div>
        <div class="ds" id="dateSub">â€”</div>
        <div id="btnToday" onclick="event.stopPropagation();goToday()" style="display:none;font-family:Orbitron,monospace;font-size:7px;letter-spacing:2px;color:var(--accent);text-shadow:0 0 8px var(--accent);cursor:pointer;margin-top:2px">â†© NOW</div>
      </div>
      <button class="dnbtn" id="btnNext" onclick="shiftDay(1)">â€º</button>
    </div>
  </div>
  <div class="stats-row">
    <div class="si"><div class="sv" id="sAct" style="color:var(--accent)">0</div><div class="sl">Active</div></div>
    <div class="si"><div class="sv" id="sDone" style="color:var(--green)">0</div><div class="sl">Done</div></div>
    <div class="si" onclick="filterUrgent()" style="cursor:pointer" title="Click to view urgent tasks"><div class="sv" id="sUrg" style="color:var(--danger)">0</div><div class="sl" style="color:var(--danger)">Urgent</div></div>
    <div class="si"><div class="sv" id="sPct" style="color:var(--gold)">0%</div><div class="sl">XP</div></div>
  </div>
  <div class="xp-bar-wrap">
    <div class="xp-label">
      <span class="xp-title">â—† DAILY XP PROGRESS</span>
      <span class="xp-val" id="xpVal">0 / 0 XP</span>
    </div>
    <div class="xp-track"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
  </div>
</div>

<!-- TABS -->
<div class="tabs-bar" id="tabsBar"></div>

<!-- MAIN -->
<div class="main" id="main"></div>

<!-- BOTTOM NAV -->
<div class="bnav">
  <button class="nbtn active" id="navQ" onclick="setPage('quests')"><span class="ni">â—†</span>QUESTS</button>
  <button class="nbtn" id="navH" onclick="setPage('history')"><span class="ni">ðŸ“…</span>HISTORY</button>
  <button class="nbtn" id="navU" onclick="undoAction()"><span class="ni">â†©</span>UNDO</button>
  <button class="nbtn" id="navR" onclick="redoAction()"><span class="ni">â†ª</span>REDO</button>
  <button class="nbtn" id="navC" onclick="openCatModal()"><span class="ni">âš™</span>CATS</button>
  <button class="nbtn" onclick="saveProfile()"><span class="ni">ðŸ’¾</span>SAVE</button>
</div>

<!-- CALENDAR MODAL -->
<div class="mo" id="calMo" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="md" onclick="event.stopPropagation()">
    <div class="md-title">â—† SELECT DATE</div>
    <div class="cal-nav-row">
      <button class="dnbtn" onclick="calShift(-1)">â€¹</button>
      <div class="cal-mo" id="calMoLabel"></div>
      <button class="dnbtn" onclick="calShift(1)">â€º</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <button class="close-md" onclick="document.getElementById('calMo').classList.remove('open')">CLOSE</button>
  </div>
</div>

<!-- CAT MODAL -->
<div class="mo" id="catMo" onclick="if(event.target===this){this.classList.remove('open');render()}">
  <div class="md" onclick="event.stopPropagation()">
    <div class="md-title">â—† MANAGE CATEGORIES</div>
    <div id="catList"></div>
    <div class="nc-row">
      <input class="nc-inp" id="ncInp" placeholder="New category..." maxlength="20"/>
      <button class="nc-add" onclick="addCat()">+ ADD</button>
    </div>
    <div class="cp-row" id="cpRow"></div>
    <button class="close-md" onclick="document.getElementById('catMo').classList.remove('open');render()">DONE</button>
  </div>
</div>

<script>
// â”€â”€â”€ CONSTANTS â”€â”€â”€
const COLORS=['#00d4ff','#ff6b35','#00ff88','#c855ff','#ffd700','#ff3355','#00ffcc','#ff88cc','#88aaff','#ffaa00'];
const XP_MAP={normal:10,hard:25,urgent:15,boss:100};
const SUBTASK_XP=5;
const DEFAULT_CATS=['DAILY','EXERCISE','STAY SHREDDED','3D CARVING'];
const DEFAULT_COLORS={'DAILY':'#00d4ff','EXERCISE':'#ff6b35','STAY SHREDDED':'#00ff88','3D CARVING':'#c855ff'};

// â”€â”€â”€ STATE â”€â”€â”€
let S={
  cats:[...DEFAULT_CATS],
  catColors:{...DEFAULT_COLORS},
  currentDate:todayStr(),
  tab:'ALL',
  view:'list',
  page:'quests',
  editing:null,
  subShowing:{},
  subCollapsed:{},
  editingSub:null,
  editingSubSub:null,
  ssShowing:{},
  inlineAdding:{},
  newPri:{},
  calMonth:null,
  newTopPri:'normal',
  newTopCat:null,
  newCatColor:COLORS[0],
  dragging:null,
};

let dayData = JSON.parse(localStorage.getItem('sl3_days')||'{}');

// â”€â”€â”€ UTILS â”€â”€â”€
function todayStr(){const d=new Date();return d.toISOString().split('T')[0]}
function uid(){return Date.now()+Math.random()}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function dateLabel(s){
  const t=todayStr();
  const yd=new Date();yd.setDate(yd.getDate()-1);
  const ys=yd.toISOString().split('T')[0];
  const tm=new Date();tm.setDate(tm.getDate()+1);
  const ts=tm.toISOString().split('T')[0];
  if(s===t)return'TODAY';
  if(s===ys)return'YESTERDAY';
  if(s===ts)return'TOMORROW';
  return new Date(s+'T00:00:00').toLocaleDateString('en-AU',{weekday:'short',month:'short',day:'numeric'}).toUpperCase();
}
function dateSub(s){return new Date(s+'T00:00:00').toLocaleDateString('en-AU',{day:'2-digit',month:'2-digit',year:'numeric'})}

const UNDO_LIMIT = 30;
const undoStack = [];
const redoStack = [];

function pushUndo(){
  undoStack.push({
    dayData: JSON.parse(JSON.stringify(dayData)),
    cats: [...S.cats],
    catColors: {...S.catColors}
  });
  if(undoStack.length > UNDO_LIMIT) undoStack.shift();
  redoStack.length = 0; // clear redo on new action
  const ubtn = document.getElementById('navU');
  if(ubtn) ubtn.classList.toggle('has-undo', undoStack.length > 0);
  const rbtn = document.getElementById('navR');
  if(rbtn) rbtn.classList.remove('has-redo');
}

function undoAction(){
  if(!undoStack.length){ showNotif('NOTHING TO UNDO'); return; }
  redoStack.push({
    dayData: JSON.parse(JSON.stringify(dayData)),
    cats: [...S.cats],
    catColors: {...S.catColors}
  });
  const snap = undoStack.pop();
  dayData = snap.dayData;
  S.cats = snap.cats;
  S.catColors = snap.catColors;
  localStorage.setItem('sl3_days', JSON.stringify(dayData));
  localStorage.setItem('sl3_cfg', JSON.stringify({cats:S.cats,catColors:S.catColors}));
  fbSave('data','days',dayData);
  fbSave('data','cfg',{cats:S.cats,catColors:S.catColors});
  const ubtn = document.getElementById('navU');
  if(ubtn) ubtn.classList.toggle('has-undo', undoStack.length > 0);
  const rbtn = document.getElementById('navR');
  if(rbtn) rbtn.classList.add('has-redo');
  render();
  showNotif('UNDONE â†©');
}

function redoAction(){
  if(!redoStack.length){ showNotif('NOTHING TO REDO'); return; }
  undoStack.push({
    dayData: JSON.parse(JSON.stringify(dayData)),
    cats: [...S.cats],
    catColors: {...S.catColors}
  });
  const snap = redoStack.pop();
  dayData = snap.dayData;
  S.cats = snap.cats;
  S.catColors = snap.catColors;
  localStorage.setItem('sl3_days', JSON.stringify(dayData));
  localStorage.setItem('sl3_cfg', JSON.stringify({cats:S.cats,catColors:S.catColors}));
  fbSave('data','days',dayData);
  fbSave('data','cfg',{cats:S.cats,catColors:S.catColors});
  const ubtn = document.getElementById('navU');
  if(ubtn) ubtn.classList.add('has-undo');
  const rbtn = document.getElementById('navR');
  if(rbtn) rbtn.classList.toggle('has-redo', redoStack.length > 0);
  render();
  showNotif('REDONE â†ª');
}

function saveAll(){
  localStorage.setItem('sl3_days',JSON.stringify(dayData));
  localStorage.setItem('sl3_cfg',JSON.stringify({cats:S.cats,catColors:S.catColors}));
  fbSave('data','days',dayData);
  fbSave('data','cfg',{cats:S.cats,catColors:S.catColors});
}

function saveUI(){
  const ui={subShowing:S.subShowing,subCollapsed:S.subCollapsed,ssShowing:S.ssShowing};
  localStorage.setItem('sl3_ui',JSON.stringify(ui));
  fbSave('data','ui',ui);
}

function loadCfg(){
  const c=JSON.parse(localStorage.getItem('sl3_cfg')||'{}');
  if(c.cats)S.cats=c.cats;
  if(c.catColors)S.catColors={...DEFAULT_COLORS,...c.catColors};
  if(!S.newTopCat)S.newTopCat=S.cats[0]||'DAILY';
  S.cats.forEach(c=>{if(!S.newPri[c])S.newPri[c]='normal'});
  // Restore subtask open/collapse state
  const uiState=JSON.parse(localStorage.getItem('sl3_ui')||'{}');
  if(uiState.subShowing)S.subShowing=uiState.subShowing;
  if(uiState.subCollapsed)S.subCollapsed=uiState.subCollapsed;
  if(uiState.ssShowing)S.ssShowing=uiState.ssShowing;
}

function getDay(ds){
  if(!dayData[ds]){
    dayData[ds]={quests:[],order:[]};
    // carry over only LOCKED quests from the most recent previous day
    const prev=Object.keys(dayData).filter(k=>k<ds).sort().pop();
    if(prev){
      const pqs=dayData[prev].quests.filter(q=>q.locked);
      if(pqs.length>0){
        const carried=pqs.map(q=>({
          ...q,
          id:uid(),
          completed:false,
          locked:true,
          subtasks:(q.subtasks||[]).map(s=>({...s,id:uid(),done:false,subsubs:(s.subsubs||[]).map(x=>({...x,id:uid(),done:false}))}))
        }));
        dayData[ds].quests=carried;
        dayData[ds].order=carried.map(q=>q.id);
      }
    }
    saveAll();
  }
  return dayData[ds];
}

function getQuests(ds,catFilter){
  const day=getDay(ds);
  let qs=[...day.quests];
  const om={};(day.order||[]).forEach((id,i)=>om[id]=i);
  qs.sort((a,b)=>(om[a.id]??9999)-(om[b.id]??9999));
  if(catFilter&&catFilter!=='ALL')qs=qs.filter(q=>q.cat===catFilter);
  return qs;
}

function questXP(q){
  let xp=XP_MAP[q.pri||'normal']||10;
  xp+=(q.subtasks||[]).length*SUBTASK_XP;
  return xp;
}

function calcXP(ds){
  const day=getDay(ds);
  let total=0,earned=0;
  day.quests.forEach(q=>{
    const qxp=questXP(q);
    total+=qxp;
    if(q.completed){
      earned+=XP_MAP[q.pri||'normal']||10;
      earned+=(q.subtasks||[]).filter(s=>s.done).length*SUBTASK_XP;
    } else {
      earned+=(q.subtasks||[]).filter(s=>s.done).length*SUBTASK_XP;
    }
  });
  return{total,earned};
}


// â”€â”€â”€ RANK SYSTEM â”€â”€â”€
const RANKS = [
  {rank:'E', minXP:0,    cls:'rank-e'},
  {rank:'D', minXP:100,  cls:'rank-d'},
  {rank:'C', minXP:300,  cls:'rank-c'},
  {rank:'B', minXP:700,  cls:'rank-b'},
  {rank:'A', minXP:1500, cls:'rank-a'},
  {rank:'S', minXP:3000, cls:'rank-s'},
];

function getRank(totalXP){
  let r=RANKS[0];
  for(const rank of RANKS){ if(totalXP>=rank.minXP) r=rank; }
  return r;
}

function calcTotalXP(){
  let totalXP=0;
  Object.values(dayData).forEach(d=>{
    (d.quests||[]).forEach(q=>{
      if(q.completed) totalXP+=XP_MAP[q.pri||'normal']||10;
      (q.subtasks||[]).forEach(s=>{
        if(s.done) totalXP+=SUBTASK_XP;
        (s.subtasks||[]).forEach(ss=>{if(ss.done)totalXP+=SUBTASK_XP;});
      });
    });
  });
  return totalXP;
}

// â”€â”€â”€ STATS â”€â”€â”€
function renderStats(){
  const day=getDay(S.currentDate);
  const qs=day.quests;
  const active=qs.filter(q=>!q.completed).length;
  const done=qs.filter(q=>q.completed).length;
  // Count urgent tasks + urgent subtasks
  let urgent=0;
  qs.forEach(q=>{
    if(!q.completed&&q.pri==='urgent') urgent++;
    (q.subtasks||[]).forEach(s=>{
      if(!s.done&&s.pri==='urgent') urgent++;
    });
  });
  const total=qs.length;
  const pct=total?Math.round(done/total*100):0;
  document.getElementById('sAct').textContent=active;
  document.getElementById('sDone').textContent=done;
  document.getElementById('sUrg').textContent=urgent;
  document.getElementById('sPct').textContent=pct+'%';

  const xp=calcXP(S.currentDate);
  const xpPct=xp.total?Math.round(xp.earned/xp.total*100):0;
  document.getElementById('xpVal').textContent=`${xp.earned} / ${xp.total} XP`;
  document.getElementById('xpFill').style.width=xpPct+'%';

  // Total XP + rank
  const totalXP=calcTotalXP();
  const el=document.getElementById('playerTotalXP');
  if(el) el.textContent=totalXP.toLocaleString();
  updateBossSkull();
  const streak=calcStreak();
  const sel=document.getElementById('streakVal');
  if(sel) sel.textContent=streak>0?`ðŸ”¥${streak}`:'â€”';
  const rankData=getRank(totalXP);
  const rb=document.getElementById('rankBadge');
  if(rb){rb.textContent=rankData.rank;rb.className='rank-badge '+rankData.cls;}
  const nextRank=RANKS[RANKS.indexOf(rankData)+1];
  const rxp=document.getElementById('rankNextXP');
  if(rxp) rxp.textContent=nextRank?`${nextRank.minXP-totalXP} TO ${nextRank.rank}`:'MAX RANK';
}

// â”€â”€â”€ TABS â”€â”€â”€
function rebuildTabs(){
  const bar=document.getElementById('tabsBar');
  bar.innerHTML='';
  ['ALL',...S.cats].forEach(cat=>{
    const btn=document.createElement('button');
    btn.className='tbtn'+(S.tab===cat?' active':'');
    btn.dataset.cat=cat;
    btn.textContent=cat;
    btn.onclick=()=>{
      S.tab=cat;
      if(cat!=='ALL') S.newTopCat=cat;
      else S.newTopCat=S.cats[0]||'DAILY';
      rebuildTabs();
      renderMain();
    };
    bar.appendChild(btn);
  });
  const sp=document.createElement('div');sp.className='tspc';bar.appendChild(sp);
  const vt=document.createElement('div');vt.className='vtog';
  vt.innerHTML=`<button class="vbtn ${S.view==='list'?'active':''}" onclick="setView('list')">â˜°</button><button class="vbtn ${S.view==='grid'?'active':''}" onclick="setView('grid')">âŠž</button>`;
  bar.appendChild(vt);
}

function setView(v){S.view=v;rebuildTabs();renderMain()}
function setPage(p){
  S.page=p;
  document.getElementById('navQ').classList.toggle('active',p==='quests');
  document.getElementById('navH').classList.toggle('active',p==='history');
  renderMain();
}

// â”€â”€â”€ MAIN RENDER â”€â”€â”€
function render(){renderStats();rebuildTabs();renderMain()}

function renderMain(){
  updateDateDisplay();
  renderStats();
  const main=document.getElementById('main');
  const scrollY=main.scrollTop;
  const restoreScroll=()=>requestAnimationFrame(()=>{main.scrollTop=scrollY;});
  if(S.page==='history'){renderHistory(main);restoreScroll();return}
  if(S.view==='grid'){renderGrid(main);restoreScroll();return}
  renderList(main);
  restoreScroll();
}

function updateDateDisplay(){
  document.getElementById('dateMain').textContent=dateLabel(S.currentDate);
  document.getElementById('dateSub').textContent=dateSub(S.currentDate);
  const todayBtn=document.getElementById('btnToday');
  if(todayBtn) todayBtn.style.display=S.currentDate!==todayStr()?'inline-flex':'none';
}

// â”€â”€â”€ LIST VIEW â”€â”€â”€
function renderList(container){
  container.innerHTML='';
  container.appendChild(buildTopInput());
  const cats=S.tab==='ALL'?S.cats:[S.tab];
  cats.forEach(cat=>{
    container.appendChild(buildCatSection(cat));
  });

  // Add collapse all / expand all button at bottom if multiple cats
  if(cats.length > 1){
    const collapseBtn = document.createElement('button');
    collapseBtn.className = 'collapse-all-btn';
    collapseBtn.id = 'collapseAllBtn';
    collapseBtn.textContent = 'â–² COLLAPSE ALL';
    collapseBtn.onclick = toggleCollapseAll;
    container.appendChild(collapseBtn);
  }
}

function buildTopInput(){
  const p=document.createElement('div');
  p.className='inp-panel';
  p.innerHTML=`
    <div class="inp-row">
      <input class="qi" id="topQI" placeholder="Enter quest..." maxlength="120" title="Select a tab first, then type your quest and hit Enter"/>
      <button class="badd" onclick="addQuestTop()">+ ADD</button>
    </div>
    <div class="inp-opts" id="topOpts"></div>
  `;
  setTimeout(()=>{
    const inp=document.getElementById('topQI');
    if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')addQuestTop()});
    buildTopOpts();
  },0);
  return p;
}

function buildTopOpts(){
  const opts=document.getElementById('topOpts');
  if(!opts)return;
  opts.innerHTML='';

  // â”€â”€ CURRENT CATEGORY INDICATOR â”€â”€
  const catIndicator=document.createElement('div');
  catIndicator.style.cssText='font-family:Orbitron,monospace;font-size:7px;letter-spacing:2px;color:rgba(0,200,255,.5);margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid rgba(0,180,255,.1)';
  const catColor=S.catColors[S.newTopCat]||'#00d4ff';
  catIndicator.innerHTML=`ADDING TO: <span style="color:${catColor};font-weight:700;text-shadow:0 0 8px ${catColor}">${S.newTopCat}</span>`;
  opts.appendChild(catIndicator);

  // â”€â”€ PRIORITY ROW â”€â”€
  const priRow=document.createElement('div');
  priRow.className='opts-row';
  const priLabel=document.createElement('span');
  priLabel.className='opts-label';
  priLabel.textContent='PRI';
  priRow.appendChild(priLabel);

  const priDefs=[
    {key:'normal', cls:'pn', label:'âš¡ NORMAL'},
    {key:'hard',   cls:'ph', label:'â˜  HARD'},
    {key:'urgent', cls:'pu', label:'âš  URGENT'},
    {key:'boss',   cls:'pb', label:'ðŸ’€ BOSS'},
  ];
  priDefs.forEach(({key,cls,label})=>{
    const sel=S.newTopPri===key;
    const btn=document.createElement('button');
    btn.className=`pri-btn ${cls}${sel?' active':''}`;
    btn.textContent=label;
    btn.onclick=()=>{S.newTopPri=key;buildTopOpts();};
    priRow.appendChild(btn);
  });
  opts.appendChild(priRow);
}

function buildCatSection(cat){
  const color=S.catColors[cat]||'#00d4ff';
  const qs=getQuests(S.currentDate,cat);
  const active=qs.filter(q=>!q.completed).length;

  const sec=document.createElement('div');
  sec.className='cat-sec';
  sec.dataset.cat=cat;

  const xpData=calcCatXP(cat);
  const xpPct=xpData.total?Math.round(xpData.earned/xpData.total*100):0;

  sec.innerHTML=`
    <div class="cat-hdr" onclick="toggleSec(this)">
      <div class="cat-dot" style="background:${color}"></div>
      <div class="cat-title" style="color:${color}">${cat}</div>
      <div class="cat-line" style="background:${color}"></div>
      <div class="cat-cnt">${active}/${qs.length}</div>
      <span class="cat-chev">â–¾</span>
    </div>
    <div class="cat-xp-wrap">
      <div class="cat-xp-track"><div class="cat-xp-fill" style="width:${xpPct}%;background:linear-gradient(90deg,${color},${color}88)"></div></div>
    </div>
    <div class="cat-body" id="cbody-${CSS.escape(cat)}"></div>
  `;

  setTimeout(()=>{
    const body=document.getElementById('cbody-'+CSS.escape(cat));
    if(!body)return;

    // drop zone for cross-cat
    const dz=document.createElement('div');
    dz.className='drop-zone';
    dz.textContent='DROP HERE TO MOVE';
    dz.dataset.dropCat=cat;
    setupDropZone(dz,cat);
    body.appendChild(dz);

    if(qs.length===0){
      const emp=document.createElement('div');
      emp.className='empty';
      emp.innerHTML=`<div class="ei">â—†</div><p>NO ${cat} QUESTS</p>`;
      body.appendChild(emp);
    } else {
      qs.forEach(q=>{
        body.appendChild(buildQuestWrap(q,cat));
      });
    }
    // inline add
    body.appendChild(buildCatAddRow(cat));
    setupContainerDrop(body,cat);
  },0);

  return sec;
}

function calcCatXP(cat){
  const day=getDay(S.currentDate);
  const qs=day.quests.filter(q=>q.cat===cat);
  let total=0,earned=0;
  qs.forEach(q=>{
    total+=questXP(q);
    if(q.completed)earned+=XP_MAP[q.pri||'normal']||10;
    earned+=(q.subtasks||[]).filter(s=>s.done).length*SUBTASK_XP;
  });
  return{total,earned};
}

function buildCatAddRow(cat){
  if(!S.newPri[cat])S.newPri[cat]='normal';
  const pri=S.newPri[cat];
  const div=document.createElement('div');
  div.innerHTML=`
    <div class="cat-add-row" data-addrow="${esc(cat)}">
      <input class="cat-add-input" id="cai-${CSS.escape(cat)}" placeholder="Add quest to ${cat}..." maxlength="120"/>
      <div class="cat-pri-sel">
        <button class="cpbtn ${pri==='normal'?'sel-n':''}" onclick="setCatPri('${esc(cat)}','normal')">N</button>
        <button class="cpbtn ${pri==='hard'?'sel-h':''}" onclick="setCatPri('${esc(cat)}','hard')">H</button>
        <button class="cpbtn ${pri==='urgent'?'sel-u':''}" onclick="setCatPri('${esc(cat)}','urgent')">U</button>
        <button class="cpbtn ${pri==='boss'?'sel-b':''}" onclick="setCatPri('${esc(cat)}','boss')">ðŸ’€</button>
      </div>
      <button class="cat-add-btn" onclick="addQuestCat('${esc(cat)}')">+</button>
    </div>
  `;
  setTimeout(()=>{
    const inp=document.getElementById('cai-'+CSS.escape(cat));
    if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')addQuestCat(cat)});
  },0);
  return div;
}

function buildQuestWrap(q,cat){
  const wrap=document.createElement('div');
  wrap.className='q-wrap';
  wrap.dataset.id=q.id;

  // inject category colour as CSS variables for glow
  const catColor=S.catColors[q.cat]||'#00e5ff';
  // parse hex to r,g,b for rgba usage
  const r=parseInt(catColor.slice(1,3),16);
  const g=parseInt(catColor.slice(3,5),16);
  const b=parseInt(catColor.slice(5,7),16);
  // For boss tasks, force purple theme overriding category colour
  if(q.pri==='boss'){
    wrap.style.setProperty('--cat-border', 'rgba(180,0,255,0.8)');
    wrap.style.setProperty('--cat-shadow', '0 0 20px rgba(160,0,255,0.4)');
    wrap.style.setProperty('--cat-inner',  'rgba(80,0,180,0.12)');
    wrap.classList.add('boss-wrap');
  } else {
    wrap.style.setProperty('--cat-color', catColor);
    wrap.style.setProperty('--cat-border', `rgba(${r},${g},${b},0.35)`);
    wrap.style.setProperty('--cat-shadow', `0 0 12px rgba(${r},${g},${b},0.18)`);
    wrap.style.setProperty('--cat-inner',  `rgba(${r},${g},${b},0.05)`);
  }

  const row=buildQuestRow(q);
  wrap.appendChild(row);
  // NOW the row is inside wrap, so closest('.q-wrap') will work
  setupDragHandle(row,q);

  // Always show subtasks if they exist
  if((q.subtasks||[]).length > 0){
    wrap.appendChild(buildSubWrap(q));
  }

  return wrap;
}

function buildQuestRow(q){
  const pri=q.pri||'normal';
  const div=document.createElement('div');
  div.className=`qi-row ${pri==='normal'?'normal':'pri-'+pri} ${q.completed?'done':''}`;
  div.dataset.id=q.id;
  div.dataset.cat=q.cat;
  if(pri==='boss'&&!q.completed){
    div.style.animation='bossPurplePulse 2s ease-in-out infinite';
    div.style.webkitAnimation='bossPurplePulse 2s ease-in-out infinite';
    div.style.borderColor='rgba(160,0,255,.7)';
    div.style.background='rgba(40,0,90,.15)';
  }

  let innerHtml='';
  innerHtml+=`<div class="dh" data-dh="${q.id}" title="Drag full stack">â‹®â‹®</div>`;
  innerHtml+=`<div class="dh-solo" data-dh="${q.id}" title="Drag row only">â†•</div>`;
  innerHtml+=`<div class="qchk" onclick="toggleQ('${q.id}')"><span class="chkmark">âœ“</span></div>`;
  innerHtml+=`<div class="qtw">`;

  if(S.editing===String(q.id)){
    innerHtml+=`<input class="qedit" data-eid="${q.id}" value="${esc(q.text)}" maxlength="120"/>`;
  } else {
    const priLabel=pri==='boss'
      ?`<span class="pri-inline pri-inline-b">ðŸ’€ BOSS RAID</span>`
      :pri==='urgent'
      ?`<span class="pri-inline pri-inline-u">âš  URGENT</span>`
      :pri==='hard'
      ?`<span class="pri-inline pri-inline-h">HARD +XP</span>`
      :'';
    innerHtml+=`<div class="qtxt">${esc(q.text)}${priLabel}</div>`;
  }
  innerHtml+=`</div>`;

  innerHtml+=`<div class="qacts">`;
  if(S.editing===String(q.id)){
    // Edit mode - show save + priority buttons inline
    innerHtml+=`<button class="qbtn qbtn-save" onclick="saveEdit('${q.id}')">âœ“</button>`;
    innerHtml+=`<button class="cpbtn ${pri==='normal'?'sel-n':''}" onclick="setQuestPri('${q.id}','normal')">N</button>`;
    innerHtml+=`<button class="cpbtn ${pri==='hard'?'sel-h':''}" onclick="setQuestPri('${q.id}','hard')">H</button>`;
    innerHtml+=`<button class="cpbtn ${pri==='urgent'?'sel-u':''}" onclick="setQuestPri('${q.id}','urgent')">U</button>`;
    innerHtml+=`<button class="cpbtn ${pri==='boss'?'sel-b':''}" onclick="setQuestPri('${q.id}','boss')">ðŸ’€</button>`;
  } else {
    // Collapsed: show lock (always visible as key action), then ... menu
    innerHtml+=`<div class="qacts-overflow" id="qo-${q.id}">`;
    if(!q.completed) innerHtml+=`<button class="qbtn qbtn-edit" onclick="startEdit('${q.id}')">âœ</button>`;
    innerHtml+=`<button class="qbtn qbtn-sub" onclick="toggleSub('${q.id}')" title="Add subtask">+</button>`;
    innerHtml+=`<button class="qbtn qbtn-dupe" onclick="dupeQ('${q.id}')" title="Duplicate">â§‰</button>`;
    innerHtml+=`<button class="qbtn qbtn-del" onclick="delQ('${q.id}')">âœ•</button>`;
    innerHtml+=`</div>`;
    innerHtml+=`<button class="qbtn qbtn-lock ${q.locked?'locked':''}" onclick="toggleLock('${q.id}')" title="${q.locked?'Locked':'Unlocked'}">${q.locked?'ðŸ”’':'ðŸ”“'}</button>`;
    innerHtml+=`<button class="qbtn qbtn-more" onclick="toggleQActsMenu('${q.id}',this)">â€¢â€¢â€¢</button>`;
  }
  innerHtml+=`</div>`;

  div.innerHTML=innerHtml;

  // edit input events
  if(S.editing===String(q.id)){
    setTimeout(()=>{
      const inp=div.querySelector('.qedit');
      if(inp){inp.focus();inp.select();inp.addEventListener('keydown',e=>{if(e.key==='Enter')saveEdit(q.id);if(e.key==='Escape'){S.editing=null;renderMain()}})}
    },0);
  }

  // drag handle attached in buildQuestWrap after appending to wrap
  return div;
}

function renderGrid(container){
  container.innerHTML='';
  container.appendChild(buildTopInput());
  const grid=document.createElement('div');
  grid.className='ov-grid';
  const cats=S.tab==='ALL'?S.cats:[S.tab];
  cats.forEach(cat=>{
    const color=S.catColors[cat]||'#00d4ff';
    const qs=getQuests(S.currentDate,cat);
    const done=qs.filter(q=>q.completed).length;
    const card=document.createElement('div');
    card.className='ov-card';
    card.style.borderTop=`2px solid ${color}`;
    card.innerHTML=`
      <div class="ov-hdr">
        <div class="ov-title" style="color:${color}">${cat}</div>
        <div class="ov-cnt" style="color:${color}">${done}/${qs.length}</div>
      </div>
      <div class="ov-body" id="ovb-${CSS.escape(cat)}"></div>
    `;
    grid.appendChild(card);
    setTimeout(()=>{
      const body=document.getElementById('ovb-'+CSS.escape(cat));
      if(!body)return;
      qs.slice(0,4).forEach(q=>{
        const row=document.createElement('div');
        row.className='mini-q'+(q.completed?' done':'');
        row.innerHTML=`<div class="mini-chk">${q.completed?'âœ“':''}</div><div class="mini-txt">${esc(q.text)}</div>`;
        row.onclick=()=>{toggleQ(q.id)};
        body.appendChild(row);
      });
      if(qs.length>4){const m=document.createElement('div');m.className='mini-more';m.textContent=`+${qs.length-4} MORE`;body.appendChild(m)}
      if(qs.length===0)body.innerHTML=`<div class="mini-more" style="padding:8px 0;text-align:center;opacity:.5">NO QUESTS</div>`;
    },0);
  });
  container.appendChild(grid);
}

// â”€â”€â”€ HISTORY â”€â”€â”€
function renderHistory(container){
  container.innerHTML='';
  const hdr=document.createElement('div');
  hdr.style.cssText='font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;color:var(--accent);padding:4px 2px 12px;';
  hdr.textContent='â—† HISTORY LOG';
  container.appendChild(hdr);
  const dates=Object.keys(dayData).sort().reverse().slice(0,30);
  if(!dates.length){container.innerHTML+='<div class="empty"><div class="ei">ðŸ“…</div><p>NO HISTORY YET</p></div>';return}
  dates.forEach(ds=>{
    const day=dayData[ds];
    if(!day||!day.quests||!day.quests.length)return;
    const done=day.quests.filter(q=>q.completed).length;
    const total=day.quests.length;
    const pct=total?Math.round(done/total*100):0;
    const card=document.createElement('div');
    card.className='hist-card';
    card.innerHTML=`
      <div class="hist-top">
        <div><div class="hist-date">${dateLabel(ds)}</div><div class="hist-sub">${dateSub(ds)}</div></div>
        <div style="text-align:right"><div class="hist-pct" style="color:${pct===100?'var(--green)':'var(--gold)'}">${pct}%</div><div class="hist-cnt">${done}/${total} quests</div></div>
      </div>
    `;
    card.onclick=()=>{S.currentDate=ds;S.page='quests';setPage('quests')};
    container.appendChild(card);
  });
}

// â”€â”€â”€ DATE NAV â”€â”€â”€
// â”€â”€â”€ GO TO TODAY â”€â”€â”€
// â”€â”€â”€ FILTER URGENT â”€â”€â”€
function filterUrgent(){
  const day=getDay(S.currentDate);
  // Collect urgent tasks AND urgent subtasks
  const urgentTasks=[];
  day.quests.forEach(q=>{
    if(q.pri==='urgent'&&!q.completed) urgentTasks.push({...q, _isSubtask:false});
    (q.subtasks||[]).forEach(s=>{
      if(s.pri==='urgent'&&!s.done) urgentTasks.push({...s, text:(q.text+' â†’ '+s.text), _isSubtask:true, _parentId:q.id, cat:q.cat});
    });
  });
  if(urgentTasks.length===0){showNotif('NO URGENT TASKS');return;}

  // Switch to ALL tab and scroll to first urgent task
  S.tab='ALL';
  rebuildTabs();
  renderMain();

  // Show urgent modal overlay listing all urgent tasks
  const existing=document.getElementById('urgentModal');
  if(existing)existing.remove();

  const mo=document.createElement('div');
  mo.id='urgentModal';
  mo.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px';
  mo.onclick=e=>{if(e.target===mo)mo.remove();};

  let html=`<div style="background:rgba(2,5,18,.97);border:1px solid rgba(255,51,85,.5);border-radius:8px;padding:20px;max-width:400px;width:100%;box-shadow:0 0 30px rgba(255,51,85,.2);max-height:80vh;overflow-y:auto">
    <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:3px;color:var(--danger);text-shadow:0 0 10px var(--danger);margin-bottom:16px">âš  URGENT QUESTS â€” ${urgentTasks.length}</div>`;

  urgentTasks.forEach(q=>{
    const clickFn = q._isSubtask
      ? `scrollToSubtask('${q._parentId}','${q.id}');document.getElementById('urgentModal').remove()`
      : `scrollToQuest('${q.id}');document.getElementById('urgentModal').remove()`;
    html+=`<div onclick="${clickFn}" style="padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,51,85,.3);border-radius:4px;cursor:pointer;background:rgba(255,51,85,.05);font-family:Rajdhani,sans-serif;font-size:14px;font-weight:600;color:var(--text);transition:all .15s" onmouseover="this.style.borderColor='rgba(255,51,85,.7)'" onmouseout="this.style.borderColor='rgba(255,51,85,.3)'">
      <span style="color:var(--danger);margin-right:8px">âš </span>${q.text}
      ${q._isSubtask?`<span style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;color:var(--purple);margin-left:6px">SUBTASK</span>`:''}
      ${q.cat?`<span style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;color:var(--mid);margin-left:6px">${q.cat}</span>`:''}
    </div>`;
  });

  html+=`<button onclick="document.getElementById('urgentModal').remove()" style="margin-top:8px;width:100%;padding:8px;background:none;border:1px solid rgba(255,51,85,.3);color:var(--danger);font-family:Orbitron,monospace;font-size:8px;letter-spacing:2px;border-radius:3px;cursor:pointer">CLOSE</button></div>`;
  mo.innerHTML=html;
  document.body.appendChild(mo);
}

function scrollToQuest(qid){
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(q&&q.cat){S.tab=q.cat;rebuildTabs();renderMain();}
  setTimeout(()=>{
    const el=document.querySelector(`.q-wrap[data-id="${qid}"]`);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },100);
}

function scrollToSubtask(parentQid, sid){
  // Navigate to the parent quest's tab first
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(parentQid));
  if(q&&q.cat){S.tab=q.cat;rebuildTabs();renderMain();}
  setTimeout(()=>{
    // Scroll parent into view first
    const qwrap=document.querySelector(`.q-wrap[data-id="${parentQid}"]`);
    if(qwrap){
      // Make sure subtasks are visible
      if(!qwrap.querySelector('.sub-wrap')){
        const dayD=getDay(S.currentDate);
        const qq=dayD.quests.find(q=>String(q.id)===String(parentQid));
        if(qq&&(qq.subtasks||[]).length>0) qwrap.appendChild(buildSubWrap(qq));
      }
      // Now find and highlight the specific subtask
      setTimeout(()=>{
        const subEl=qwrap.querySelector(`.sub-item[data-sid="${sid}"]`);
        if(subEl){
          subEl.scrollIntoView({behavior:'smooth',block:'center'});
          // Flash highlight
          subEl.style.transition='box-shadow .15s';
          subEl.style.boxShadow='0 0 0 2px rgba(255,51,85,.9), 0 0 16px rgba(255,51,85,.5)';
          setTimeout(()=>{subEl.style.boxShadow='';},1500);
        } else {
          qwrap.scrollIntoView({behavior:'smooth',block:'center'});
        }
      },120);
    }
  },100);
}

// â”€â”€â”€ BOSS SKULL â”€â”€â”€
function updateBossSkull(){
  const day=getDay(S.currentDate);
  let bossCount=0;
  day.quests.forEach(q=>{
    if(q.pri==='boss'&&!q.completed) bossCount++;
    (q.subtasks||[]).forEach(s=>{if(s.pri==='boss'&&!s.done)bossCount++;});
  });
  // check all days for boss tasks
  let totalBoss=0;
  const _seenB=new Set();
  Object.values(dayData).forEach(d=>{
    (d.quests||[]).forEach(q=>{
      const _bkey=(q.originalId)||((q.text||'')+'|'+(q.cat||''));
      if(q.pri==='boss'&&!q.completed&&!_seenB.has(_bkey)){
        _seenB.add(_bkey);
        totalBoss++;
      }
    });
  });
  const skull=document.getElementById('bossSkull');
  const cnt=document.getElementById('bossSkullCount');
  if(skull){skull.style.display=totalBoss>0?'block':'none';}
  if(cnt)cnt.textContent=totalBoss;
}

function showBossRaids(){
  const existing=document.getElementById('bossModal');
  if(existing)existing.remove();
  const allBoss=[];
  // Deduplicate by text+cat (most reliable since originalId may not exist on old data)
  const seenBoss=new Set();
  const sortedEntries=Object.entries(dayData).sort(([a],[b])=>b.localeCompare(a));
  sortedEntries.forEach(([ds,d])=>{
    (d.quests||[]).forEach(q=>{
      const key=(q.originalId)||((q.text||'')+'|'+(q.cat||''));
      if(q.pri==='boss'&&!q.completed&&!seenBoss.has(key)){
        seenBoss.add(key);
        allBoss.push({...q,_date:ds});
      }
    });
  });
  if(!allBoss.length){showNotif('NO ACTIVE BOSS RAIDS');return;}

  const mo=document.createElement('div');
  mo.id='bossModal';
  mo.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px';
  mo.onclick=e=>{if(e.target===mo)mo.remove();};

  let html=`<div style="background:rgba(5,0,18,.97);border:1px solid rgba(160,0,255,.6);border-radius:8px;padding:20px;max-width:420px;width:100%;box-shadow:0 0 40px rgba(160,0,255,.3);max-height:80vh;overflow-y:auto">
    <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:3px;color:#c040ff;text-shadow:0 0 12px #c040ff;margin-bottom:16px">ðŸ’€ ACTIVE BOSS RAIDS â€” ${allBoss.length}</div>`;
  allBoss.forEach(q=>{
    const isToday=q._date===todayStr();
    html+=`<div onclick="if('${q._date}'===S.currentDate){scrollToQuest('${q.id}');}else{S.currentDate='${q._date}';render();setTimeout(()=>scrollToQuest('${q.id}'),200);}document.getElementById('bossModal').remove()"
      style="padding:10px 12px;margin-bottom:8px;border:1px solid rgba(160,0,255,.35);border-radius:4px;cursor:pointer;background:rgba(80,0,160,.1);font-family:Rajdhani,sans-serif;font-size:14px;font-weight:600;color:#e0b0ff"
      onmouseover="this.style.borderColor='rgba(200,50,255,.8)'" onmouseout="this.style.borderColor='rgba(160,0,255,.35)'">
      <span style="margin-right:8px">ðŸ’€</span>${q.text}
      <span style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;color:rgba(160,0,255,.6);margin-left:8px">${q.cat||''}</span>
      ${isToday?'<span style="font-family:Orbitron,monospace;font-size:7px;color:#00d4ff;margin-left:6px">TODAY</span>':''}
    </div>`;
  });
  html+=`<button onclick="document.getElementById('bossModal').remove()" style="margin-top:8px;width:100%;padding:8px;background:none;border:1px solid rgba(160,0,255,.3);color:#c040ff;font-family:Orbitron,monospace;font-size:8px;letter-spacing:2px;border-radius:3px;cursor:pointer">CLOSE</button></div>`;
  mo.innerHTML=html;
  document.body.appendChild(mo);
}

function toggleSubMenu(menuId, btn){
  document.querySelectorAll('.sub-overflow.open').forEach(el=>{
    if(el.id!==menuId){el.classList.remove('open');}
  });
  document.querySelectorAll('.sub-more-btn.open').forEach(el=>{
    if(el!==btn)el.classList.remove('open');
  });
  const menu=document.getElementById(menuId);
  if(!menu)return;
  menu.classList.toggle('open');
  btn.classList.toggle('open');
}

function toggleQActsMenu(qid, btn){
  // Close any other open menus first
  document.querySelectorAll('.qacts-overflow.open').forEach(el=>{
    if(el.id!=='qo-'+qid){el.classList.remove('open');}
  });
  document.querySelectorAll('.qbtn-more.open').forEach(el=>{
    if(el!==btn)el.classList.remove('open');
  });
  const menu=document.getElementById('qo-'+qid);
  if(!menu)return;
  const isOpen=menu.classList.contains('open');
  menu.classList.toggle('open',!isOpen);
  btn.classList.toggle('open',!isOpen);
}
// Close menus when clicking elsewhere - use mousedown so button clicks fire first
document.addEventListener('mousedown',e=>{
  if(!e.target.closest('.qacts')&&!e.target.closest('.sub-acts')){
    document.querySelectorAll('.qacts-overflow.open').forEach(el=>el.classList.remove('open'));
    document.querySelectorAll('.qbtn-more.open').forEach(el=>el.classList.remove('open'));
    document.querySelectorAll('.sub-overflow.open').forEach(el=>el.classList.remove('open'));
    document.querySelectorAll('.sub-more-btn.open').forEach(el=>el.classList.remove('open'));
  }
},{passive:true});

function goToday(){
  S.currentDate = todayStr();
  render();
  document.getElementById('btnToday').style.display='none';
}

// â”€â”€â”€ COLLAPSE ALL / EXPAND ALL â”€â”€â”€
let allCollapsed = false;
function toggleCollapseAll(){
  allCollapsed = !allCollapsed;
  document.querySelectorAll('.cat-sec').forEach(sec=>{
    if(allCollapsed) sec.classList.add('collapsed');
    else sec.classList.remove('collapsed');
  });
  const btn = document.getElementById('collapseAllBtn');
  if(btn) btn.textContent = allCollapsed ? 'â–¼ EXPAND ALL' : 'â–² COLLAPSE ALL';
}

// â”€â”€â”€ STREAK CALCULATION â”€â”€â”€
function calcStreak(){
  const today = todayStr();
  let streak = 0;
  let d = new Date();
  // check yesterday first (today may not be complete yet)
  d.setDate(d.getDate()-1);
  while(true){
    const ds = d.toISOString().split('T')[0];
    const day = dayData[ds];
    if(!day || !day.quests || day.quests.length === 0) break;
    const allDone = day.quests.every(q=>q.completed||q.locked);
    if(!allDone) break;
    streak++;
    d.setDate(d.getDate()-1);
    if(streak > 365) break;
  }
  return streak;
}

function shiftDay(delta){
  const parts=S.currentDate.split('-').map(Number);
  const d=new Date(parts[0],parts[1]-1,parts[2]);
  d.setDate(d.getDate()+delta);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  const fromDate=S.currentDate;
  S.currentDate=`${y}-${m}-${day}`;

  // When going forward, sync locked quests from the source day into target day
  if(delta>0){
    carryLockedQuests(fromDate, S.currentDate);
  }

  render();
}

function carryLockedQuests(fromDate, toDate){
  const src=dayData[fromDate];
  if(!src)return;
  const locked=src.quests.filter(q=>q.locked);
  if(!locked.length)return;

  if(!dayData[toDate])dayData[toDate]={quests:[],order:[]};
  const dest=dayData[toDate];

  // Build a map of existing carried quests in dest (by text+cat)
  locked.forEach(srcQ=>{
    const already=dest.quests.find(dq=>dq.locked&&dq.text===srcQ.text&&dq.cat===srcQ.cat);
    if(already){
      // Update priority in case it changed
      already.pri=srcQ.pri;
    } else {
      const newQ={
        ...srcQ,
        id:uid(),
        originalId:srcQ.originalId||String(srcQ.id), // track source for dedup
        completed:false,
        locked:true,
        subtasks:(srcQ.subtasks||[]).filter(s=>{
          // Only carry subtask if it's locked OR not yet done
          return s.recurring || !s.done;
        }).map(s=>({
          ...s,
          id:uid(),
          // locked subtasks reset to undone each day
          done: s.recurring ? false : s.done
        }))
      };
      dest.quests.push(newQ);
      if(!dest.order)dest.order=[];
      dest.order.push(newQ.id);
    }
  });

  // Re-sort dest.order so locked quests appear in the same relative order as in src
  // Get the src order positions for locked quests
  const srcOrder=src.order||src.quests.map(q=>q.id);
  const srcLockedIds=srcOrder.filter(id=>{
    const q=src.quests.find(q=>String(q.id)===String(id));
    return q&&q.locked;
  });

  // For each locked quest in src order, find its counterpart in dest and reorder
  const destLockedInOrder=[];
  srcLockedIds.forEach(srcId=>{
    const srcQ=src.quests.find(q=>String(q.id)===String(srcId));
    if(!srcQ)return;
    const destQ=dest.quests.find(dq=>dq.locked&&dq.text===srcQ.text&&dq.cat===srcQ.cat);
    if(destQ)destLockedInOrder.push(String(destQ.id));
  });

  // Rebuild dest.order: non-locked quests keep their positions, locked quests slot in matching src order
  const nonLockedOrder=(dest.order||[]).filter(id=>{
    const q=dest.quests.find(q=>String(q.id)===String(id));
    return q&&!q.locked;
  });

  // Interleave: locked quests go first (preserving src order), then non-locked
  dest.order=[...destLockedInOrder,...nonLockedOrder.filter(id=>!destLockedInOrder.includes(id))];

  saveAll();
}

// â”€â”€â”€ CALENDAR â”€â”€â”€
function openCal(){
  S.calMonth=S.currentDate.substring(0,7);
  renderCal();
  document.getElementById('calMo').classList.add('open');
}
function calShift(d){
  const[y,m]=S.calMonth.split('-').map(Number);
  const nd=new Date(y,m-1+d,1);
  S.calMonth=`${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}`;
  renderCal();
}
function renderCal(){
  const[y,m]=S.calMonth.split('-').map(Number);
  const today=todayStr();
  document.getElementById('calMoLabel').textContent=new Date(y,m-1,1).toLocaleDateString('en-AU',{month:'long',year:'numeric'}).toUpperCase();
  const grid=document.getElementById('calGrid');
  grid.innerHTML='';
  ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d=>{const h=document.createElement('div');h.className='cdh';h.textContent=d;grid.appendChild(h)});
  const first=new Date(y,m-1,1).getDay();
  const dim=new Date(y,m,0).getDate();
  for(let i=0;i<first;i++){const e=document.createElement('div');e.className='cd other';grid.appendChild(e)}
  for(let d=1;d<=dim;d++){
    const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const div=document.createElement('div');
    div.className='cd';
    if(ds===today)div.classList.add('today');
    if(ds===S.currentDate)div.classList.add('selected');
    if(dayData[ds]&&dayData[ds].quests&&dayData[ds].quests.length)div.classList.add('has-data');
    if(ds>todayStr())div.classList.add('future-date');
    div.textContent=d;
    div.onclick=()=>{
      const from=S.currentDate;
      S.currentDate=ds;
      if(ds>from) carryLockedQuests(from,ds);
      document.getElementById('calMo').classList.remove('open');
      render();
    };
    grid.appendChild(div);
  }
}

// â”€â”€â”€ QUEST ACTIONS â”€â”€â”€
function addQuestTop(){
  const inp=document.getElementById('topQI');
  if(!inp)return;
  const text=inp.value.trim();
  if(!text)return;
  inp.value='';
  addQ(text,S.newTopCat||S.cats[0],S.newTopPri||'normal','topQI');
}

function addQuestCat(cat){
  const inp=document.getElementById('cai-'+CSS.escape(cat));
  if(!inp)return;
  const text=inp.value.trim();
  if(!text)return;
  inp.value='';
  addQ(text,cat,S.newPri[cat]||'normal','cai-'+CSS.escape(cat));
}

function setCatPri(cat,pri){
  S.newPri[cat]=pri;
  const row=document.querySelector(`.cat-add-row[data-addrow="${cat}"]`);
  if(row){
    row.querySelectorAll('.cpbtn').forEach(b=>{
      b.className='cpbtn';
      if(b.textContent==='N'&&pri==='normal')b.classList.add('sel-n');
      if(b.textContent==='H'&&pri==='hard')b.classList.add('sel-h');
      if(b.textContent==='U'&&pri==='urgent')b.classList.add('sel-u');
      if(b.textContent==='ðŸ’€'&&pri==='boss')b.classList.add('sel-b');
    });
  }
}

function addQ(text,cat,pri,refocusId){
  pushUndo();
  const day=getDay(S.currentDate);
  const q={id:uid(),text,cat,pri:pri||'normal',completed:false,locked:false,subtasks:[],createdAt:new Date().toISOString()};
  day.quests.push(q);
  if(!day.order)day.order=[];
  day.order.push(q.id);
  saveAll();
  render();
  if(refocusId){
    const el=document.getElementById(refocusId);
    if(el){el.focus();el.value='';}
  }
  showNotif('QUEST ACCEPTED');
  doFlash();
}

function toggleQ(id){
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(id));
  if(!q)return;
  pushUndo();
  q.completed=!q.completed;

  // Cascade tick/untick to all subtasks and sub-subtasks
  (q.subtasks||[]).forEach(s=>{
    s.done=q.completed;
    (s.subsubs||[]).forEach(x=>{ x.done=q.completed; });
  });

  // If boss task ticked, sync completion to all locked copies across days
  if(q.pri==='boss'){
    const bossKey=(q.originalId)||(q.text+'|'+q.cat);
    Object.values(dayData).forEach(d=>{
      (d.quests||[]).forEach(dq=>{
        const dqKey=(dq.originalId)||(dq.text+'|'+dq.cat);
        if(dqKey===bossKey && String(dq.id)!==String(q.id)){
          dq.completed=q.completed;
        }
      });
    });
  }

  saveAll();

  if(q.completed){
    const xp=XP_MAP[q.pri||'normal']||10;
    if(q.pri==='boss') showNotif('ðŸ’€ BOSS DEFEATED! +100 XP');
    else showCompleteOverlay(`+${xp} XP EARNED`);
    doFlash();
  }

  // update without full re-render
  const row=document.querySelector(`.qi-row[data-id="${id}"]`);
  if(row){
    row.classList.toggle('done',q.completed);
    const chkmark=row.querySelector('.chkmark');
    if(chkmark){chkmark.style.opacity=q.completed?'1':'0';chkmark.style.transform=q.completed?'scale(1)':'scale(0)'}
    const chk=row.querySelector('.qchk');
    if(chk){chk.style.background=q.completed?'var(--green)':'';chk.style.borderColor=q.completed?'var(--green)':''}
    const txt=row.querySelector('.qtxt');
    if(txt){txt.style.textDecoration=q.completed?'line-through':'';txt.style.color=q.completed?'var(--dim)':''}
    const acts=row.querySelector('.qacts');
    if(acts&&S.editing!==String(id)){
      let h=``;
      if(!q.completed)h+=`<button class="qbtn qbtn-edit" onclick="startEdit('${id}')">âœ</button>`;
      h+=`<button class="qbtn qbtn-sub" onclick="toggleSub('${id}')" title="Subtasks">+</button>`;
      h+=`<button class="qbtn qbtn-del" onclick="delQ('${id}')">âœ•</button>`;
      acts.innerHTML=h;
    }
  }

  // Rebuild subtask panel only if subtasks exist
  const _q2=getDay(S.currentDate).quests.find(q=>String(q.id)===String(id));
  if(_q2&&(_q2.subtasks||[]).length>0){
    rebuildSubWrap(id);
  } else {
    // Remove any ghost sub-wrap
    const qwrap=document.querySelector(`.q-wrap[data-id="${id}"]`);
    if(qwrap){const sw=qwrap.querySelector('.sub-wrap');if(sw)sw.remove();}
  }

  renderStats();
  updateCatXPBar(q.cat);
}

function updateCatXPBar(cat){
  const xpData=calcCatXP(cat);
  const xpPct=xpData.total?Math.round(xpData.earned/xpData.total*100):0;
  const fill=document.querySelector(`#cbody-${CSS.escape(cat)}`);
  if(fill){
    const track=fill.closest('.cat-sec')?.querySelector('.cat-xp-fill');
    if(track)track.style.width=xpPct+'%';
  }
  renderStats();
}

function startEdit(id){S.editing=String(id);renderMain()}
function saveEdit(id){
  pushUndo();
  const inp=document.querySelector(`.qedit[data-eid="${id}"]`);
  if(inp&&inp.value.trim()){
    const day=getDay(S.currentDate);
    const q=day.quests.find(q=>String(q.id)===String(id));
    if(q)q.text=inp.value.trim();
  }
  S.editing=null;saveAll();renderMain();
}

function delQ(id){
  pushUndo();
  const day=getDay(S.currentDate);
  day.quests=day.quests.filter(q=>String(q.id)!==String(id));
  day.order=(day.order||[]).filter(oid=>String(oid)!==String(id));
  S.editing=null;saveAll();render();
}

function toggleLock(id){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(id));
  if(!q)return;
  q.locked=!q.locked;
  saveAll();
  // just update the button in place, no full re-render
  const btn=document.querySelector(`.qi-row[data-id="${id}"] .qbtn-lock`);
  if(btn){
    btn.classList.toggle('locked',q.locked);
    btn.textContent=q.locked?'ðŸ”’':'ðŸ”“';
    btn.title=q.locked?'Locked - carries to next day':'Unlocked - tap to lock';
  }
  showNotif(q.locked?'ðŸ”’ LOCKED â€” CARRIES FORWARD':'ðŸ”“ UNLOCKED');
}

const subPriState = {};

function setSubPriById(inputId, pri){
  subPriState[inputId] = pri;
  document.querySelectorAll(`[data-subpri="${inputId}"]`).forEach(b=>{
    const v=b.dataset.val;
    b.className='cpbtn';
    if(v==='normal'&&pri==='normal')b.classList.add('sel-n');
    if(v==='hard'&&pri==='hard')b.classList.add('sel-h');
    if(v==='urgent'&&pri==='urgent')b.classList.add('sel-u');
  });
}

function subItemPriClick(btn,pri){
  const row=btn.closest('.sub-item');
  if(!row)return;
  const qid=row.dataset.priQid;
  const sid=row.dataset.priSid;
  const depth=parseInt(row.dataset.priDepth)||1;
  const xid=row.dataset.priXid||'';
  setSubItemPri(qid,sid,depth,pri,xid);
}

function setSubPri(qid,pri){ setSubPriById('sai-'+qid+'-d1', pri); }

function rebuildSubWrap(qid){
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const qwrap=document.querySelector(`.q-wrap[data-id="${qid}"]`);
  if(!qwrap)return;
  const existing=qwrap.querySelector('.sub-wrap');
  if(existing)existing.remove();
  // Only show sub-wrap if there are actual subtasks
  if((q.subtasks||[]).length>0){
    qwrap.appendChild(buildSubWrap(q));
  }
}

// â”€â”€ Build a sub-item row (shared by level 1 and 2) â”€â”€
function buildSubItemRow(s, opts){
  // opts: {qid, depth, isEditing, onToggle, onEdit, onSave, onSetPri, onDel}
  const spri=s.pri||'normal';
  const priColor=spri==='urgent'?'var(--danger)':spri==='hard'?'#ffaa00':'transparent';
  const priLabel=spri==='boss'
    ?`<span class="pri-inline pri-inline-b">ðŸ’€ BOSS</span>`
    :spri!=='normal'
    ?`<span class="pri-inline ${spri==='urgent'?'pri-inline-u':'pri-inline-h'}">${spri==='urgent'?'âš  URGENT':'HARD'}</span>`
    :'';

  const row=document.createElement('div');
  row.dataset.priQid=opts.priQid||'';
  row.dataset.priSid=opts.priSid||'';
  row.dataset.priDepth=opts.priDepth||'1';
  row.dataset.priXid=opts.priXid||'';
  const _spriClass=spri==='urgent'?' sub-urgent':spri==='boss'?' sub-boss':'';
  row.className='sub-item'+_spriClass+(s.done?' done':'');
  row.dataset.sid=s.id;
  row.style.borderLeft=`2px solid ${priColor}`;

  if(opts.isEditing){
    row.innerHTML=`
      <div class="sub-dh" title="Drag to reorder, or drop on task/subtask to nest">â‹®â‹®</div>
      <div class="sub-chk" onclick="${opts.onToggle}">${s.done?'âœ“':''}</div>
      <input class="sub-edit-inp" data-sid="${s.id}" value="${esc(s.text)}" maxlength="80"/>
      <button class="sub-save-btn" onclick="${opts.onSave}">âœ“</button>
      <button class="cpbtn ${spri==='normal'?'sel-n':''}" onclick="subItemPriClick(this,'normal')">N</button>
      <button class="cpbtn ${spri==='hard'?'sel-h':''}" onclick="subItemPriClick(this,'hard')">H</button>
      <button class="cpbtn ${spri==='urgent'?'sel-u':''}" onclick="subItemPriClick(this,'urgent')">U</button>
      <button class="cpbtn ${spri==='boss'?'sel-b':''}" onclick="subItemPriClick(this,'boss')">ðŸ’€</button>
      <button class="sub-del" onclick="${opts.onDel}">âœ•</button>
    `;
    setTimeout(()=>{
      const inp=row.querySelector('.sub-edit-inp');
      if(inp){
        inp.focus();inp.select();
        inp.addEventListener('keydown',e=>{
          if(e.key==='Enter')eval(opts.onSave);
          if(e.key==='Escape'){ if(opts.depth===1){S.editingSub=null;}else{S.editingSubSub=null;} rebuildSubWrap(opts.qid); }
        });
      }
    },0);
  } else {
    const ssToggleBtn=opts.depth===1
      ?`<button class="sub-edit-btn" onclick="toggleChecklist('${opts.qid}','${opts.priSid}')" title="Subtasks" style="color:var(--purple);border-color:rgba(136,85,255,.3)">âŠž</button>`
      :'';
    const dupeBtn=opts.depth===1
      ?`<button class="sub-dupe-btn" onclick="dupeSub1('${opts.qid}','${opts.priSid}')" title="Duplicate">â§‰</button>`
      :`<button class="sub-dupe-btn" onclick="dupeSub2('${opts.qid}','${opts.priSid}','${opts.priXid}')" title="Duplicate">â§‰</button>`;
    const subMenuId=`so-${opts.qid}-${s.id}`;
    row.innerHTML=`
      <div class="sub-dh" title="Drag to reorder, or drop on task/subtask to nest">â‹®â‹®</div>
      <div class="sub-chk" onclick="${opts.onToggle}">${s.done?'âœ“':''}</div>
      <div class="sub-txt">${esc(s.text)}${priLabel}${s.recurring?'<span class="sub-lock-icon">ðŸ”’</span>':''}</div>
      <div class="sub-acts">
        <div class="sub-overflow" id="${subMenuId}">
          <button class="sub-edit-btn" onclick="${opts.onEdit}">âœ</button>
          ${ssToggleBtn}
          ${dupeBtn}
          <button class="sub-recur-btn ${s.recurring?'active':''}" onclick="${opts.onRecur}" title="${s.recurring?'Locked - carries forward unticked':'Unlocked - stays ticked when done'}">ðŸ”’</button>
          <button class="sub-del" onclick="${opts.onDel}">âœ•</button>
        </div>
        <button class="sub-more-btn" onclick="toggleSubMenu('${subMenuId}',this)">â€¢â€¢â€¢</button>
      </div>
    `;
  }
  return row;
}

function buildSubWrap(q){
  const qid=String(q.id);
  const key=qid+'_subs';
  const collapsed=S.subCollapsed[key]||false;
  const subs=q.subtasks||[];
  const done=subs.filter(s=>s.done).length;

  const wrap=document.createElement('div');
  wrap.className='sub-wrap';

  // header
  const hdr=document.createElement('div');
  hdr.className='sub-hdr';
  hdr.innerHTML=`<span class="sub-hdr-icon">${collapsed?'â–¶':'â–¼'}</span><span class="sub-hdr-label">SUBTASKS</span><span class="sub-hdr-count">${done}/${subs.length}</span>`;
  hdr.onclick=()=>{S.subCollapsed[key]=!S.subCollapsed[key];saveUI();rebuildSubWrap(qid);};
  wrap.appendChild(hdr);

  if(!collapsed){
    const list=document.createElement('div');
    list.className='sub-list';
    list.dataset.qid=qid;
    list.dataset.depth='1';

    subs.forEach(s=>{
      const sid=String(s.id);
      const isEditing=S.editingSub===sid;
      const row=buildSubItemRow(s,{
        qid,depth:1,isEditing,
        onToggle:`toggleSub1('${qid}','${sid}')`,
        onEdit:`startSubEdit('${qid}','${sid}')`,
        onSave:`saveSubEdit('${qid}','${sid}')`,
        onRecur:`toggleSubRecur('${qid}','${sid}')`,
        priQid:qid, priSid:sid, priDepth:'1', priXid:'',
        onDel:`delSub1('${qid}','${sid}')`
      });
      list.appendChild(row);

      // â”€â”€ Checklist (sub-subtasks) â€” only shown when toggled or has items â”€â”€
      const ssKey=sid+'_ss';
      const ss=s.subsubs||[];
      
      if(S.ssShowing[sid]){
        const ssCollapsed=S.subCollapsed[ssKey]||false;
        const ssDone=ss.filter(x=>x.done).length;

        const ssWrap=document.createElement('div');
        ssWrap.className='subsub-wrap';

        const ssHdr=document.createElement('div');
        ssHdr.className='sub-hdr subsub-hdr';
        ssHdr.innerHTML=`<span class="sub-hdr-icon">${ssCollapsed?'â–¶':'â–¼'}</span><span class="sub-hdr-label" style="color:var(--purple)">SUBTASKS</span><span class="sub-hdr-count">${ssDone}/${ss.length}</span>`;
        ssHdr.onclick=()=>{S.subCollapsed[ssKey]=!S.subCollapsed[ssKey];saveUI();rebuildSubWrap(qid);};
        ssWrap.appendChild(ssHdr);

        if(!ssCollapsed){
          const ssList=document.createElement('div');
          ssList.className='sub-list';
          ssList.dataset.qid=qid;
          ssList.dataset.sid=sid;
          ssList.dataset.depth='2';

          ss.forEach(x=>{
            const xid=String(x.id);
            const editingThis=S.editingSubSub&&S.editingSubSub.sid===sid&&S.editingSubSub.xid===xid;
            const xrow=buildSubItemRow(x,{
              qid,depth:2,isEditing:editingThis,
              onToggle:`toggleSub2('${qid}','${sid}','${xid}')`,
              onEdit:`startSubSubEdit('${qid}','${sid}','${xid}')`,
              onSave:`saveSubSubEdit('${qid}','${sid}','${xid}')`,
              priQid:qid, priSid:sid, priDepth:'2', priXid:xid,
              onDel:`delSub2('${qid}','${sid}','${xid}')`
            });
            ssList.appendChild(xrow);
          });

          setupSubDragGeneric(ssList, qid, 2, sid);

          const ssAddId=`sai-${sid}-d2`;
          const ssAdd=document.createElement('div');
          ssAdd.className='sub-add-row subsub-add';
          ssAdd.innerHTML=`
            <input class="sub-add-inp" id="${ssAddId}" placeholder="Add subtask..." maxlength="80"/>
            <div class="cat-pri-sel">
              <button class="cpbtn sel-n" data-subpri="${ssAddId}" data-val="normal" onclick="setSubPriById('${ssAddId}','normal')">N</button>
              <button class="cpbtn" data-subpri="${ssAddId}" data-val="hard" onclick="setSubPriById('${ssAddId}','hard')">H</button>
              <button class="cpbtn" data-subpri="${ssAddId}" data-val="urgent" onclick="setSubPriById('${ssAddId}','urgent')">U</button>
            </div>
            <button class="sub-add-btn" onclick="addSub2('${qid}','${sid}')">ADD</button>
          `;
          setTimeout(()=>{
            const inp=document.getElementById(ssAddId);
            if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')addSub2(qid,sid);});
          },0);
          ssWrap.appendChild(ssList);
          ssWrap.appendChild(ssAdd);
        }
        list.appendChild(ssWrap);
      }
    });

    setupSubDragGeneric(list, qid, 1, null);

    // add subtask row
    const subAddId=`sai-${qid}-d1`;
    const addRow=document.createElement('div');
    addRow.className='sub-add-row';
    addRow.innerHTML=`
      <input class="sub-add-inp" id="${subAddId}" placeholder="Add subtask..." maxlength="80"/>
      <div class="cat-pri-sel">
        <button class="cpbtn sel-n" data-subpri="${subAddId}" data-val="normal" onclick="setSubPriById('${subAddId}','normal')">N</button>
        <button class="cpbtn" data-subpri="${subAddId}" data-val="hard" onclick="setSubPriById('${subAddId}','hard')">H</button>
        <button class="cpbtn" data-subpri="${subAddId}" data-val="urgent" onclick="setSubPriById('${subAddId}','urgent')">U</button>
      </div>
      <button class="sub-add-btn" onclick="addSubtask('${qid}')">+ SUB</button>
    `;
    setTimeout(()=>{
      const inp=document.getElementById(subAddId);
      if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')addSubtask(qid);});
    },0);
    wrap.appendChild(list);
    wrap.appendChild(addRow);
  }
  return wrap;
}

// â”€â”€ Subtask actions â”€â”€
function addSubtask(qid){
  pushUndo();
  const addId=`sai-${qid}-d1`;
  const inp=document.getElementById(addId)||document.getElementById('sai-'+qid);
  if(!inp)return;
  const text=inp.value.trim();
  if(!text)return;
  const pri=subPriState[addId]||subPriState[qid]||'normal';
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  if(!q.subtasks)q.subtasks=[];
  q.subtasks.push({id:uid(),text,pri,done:false,subsubs:[]});
  saveAll();
  inp.value='';
  rebuildSubWrap(qid);
  renderStats();
}

function addSub2(qid,sid){
  pushUndo();
  const addId=`sai-${sid}-d2`;
  const inp=document.getElementById(addId);
  if(!inp)return;
  const text=inp.value.trim();
  if(!text)return;
  const pri=subPriState[addId]||'normal';
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  if(!s.subsubs)s.subsubs=[];
  s.subsubs.push({id:uid(),text,pri,done:false});
  saveAll();
  inp.value='';
  rebuildSubWrap(qid);
  renderStats();
}

function toggleChecklist(qid,sid){
  S.ssShowing[sid]=!S.ssShowing[sid];
  saveUI();
  rebuildSubWrap(qid);
}

function toggleSub(qid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  if(!q.subtasks)q.subtasks=[];
  const newSub={id:Date.now(),text:'',done:false,subtasks:[]};
  q.subtasks.push(newSub);
  // Immediately put new subtask into edit mode so user can type right away
  S.editingSub=String(newSub.id);
  saveAll();
  const qwrap=document.querySelector(`.q-wrap[data-id="${qid}"]`);
  if(!qwrap)return;
  const existing=qwrap.querySelector('.sub-wrap');
  if(existing) existing.remove();
  qwrap.appendChild(buildSubWrap(q));
  setTimeout(()=>{
    const inp=qwrap.querySelector('.sub-edit-inp');
    if(inp){inp.focus();inp.select();}
  },50);
}

function toggleSubRecur(qid,sid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  s.recurring=!s.recurring;
  saveAll();
  rebuildSubWrap(qid);
}

function startSubEdit(qid,sid){S.editingSub=String(sid);rebuildSubWrap(qid);}
function saveSubEdit(qid,sid){
  pushUndo();
  const inp=document.querySelector(`.sub-edit-inp[data-sid="${sid}"]`);
  const text=inp?inp.value.trim():'';
  if(text){
    const day=getDay(S.currentDate);
    const q=day.quests.find(q=>String(q.id)===String(qid));
    if(q){const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));if(s)s.text=text;saveAll();}
  }
  S.editingSub=null;rebuildSubWrap(qid);
}

function startSubSubEdit(qid,sid,xid){S.editingSubSub={sid,xid};rebuildSubWrap(qid);}
function saveSubSubEdit(qid,sid,xid){
  pushUndo();
  const inp=document.querySelector(`.sub-edit-inp[data-sid="${xid}"]`);
  const text=inp?inp.value.trim():'';
  if(text){
    const day=getDay(S.currentDate);
    const q=day.quests.find(q=>String(q.id)===String(qid));
    if(q){
      const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
      if(s){const x=(s.subsubs||[]).find(x=>String(x.id)===String(xid));if(x)x.text=text;saveAll();}
    }
  }
  S.editingSubSub=null;rebuildSubWrap(qid);
}

function setSubItemPri(qid,sid,depth,pri,xid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  if(depth===1){
    const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
    if(s){s.pri=pri;saveAll();rebuildSubWrap(qid);}
  } else {
    const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
    if(s){const x=(s.subsubs||[]).find(x=>String(x.id)===String(xid));if(x){x.pri=pri;saveAll();rebuildSubWrap(qid);}}
  }
}

function toggleSub1(qid,sid){
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  pushUndo();s.done=!s.done;saveAll();
  const row=document.querySelector(`.sub-item[data-sid="${sid}"]`);
  if(row){
    row.classList.toggle('done',s.done);
    const chk=row.querySelector('.sub-chk');if(chk)chk.textContent=s.done?'âœ“':'';
    const txt=row.querySelector('.sub-txt');if(txt){txt.style.textDecoration=s.done?'line-through':'';txt.style.color=s.done?'var(--dim)':'';}
  }
  if(s.done)showNotif(`+${SUBTASK_XP} XP`);
  renderStats();updateCatXPBar(q.cat);
}

function toggleSub2(qid,sid,xid){
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  const x=(s.subsubs||[]).find(x=>String(x.id)===String(xid));
  if(!x)return;
  pushUndo();x.done=!x.done;saveAll();
  const row=document.querySelector(`.sub-item[data-sid="${xid}"]`);
  if(row){
    row.classList.toggle('done',x.done);
    const chk=row.querySelector('.sub-chk');if(chk)chk.textContent=x.done?'âœ“':'';
    const txt=row.querySelector('.sub-txt');if(txt){txt.style.textDecoration=x.done?'line-through':'';txt.style.color=x.done?'var(--dim)':'';}
  }
  if(x.done)showNotif(`+${SUBTASK_XP} XP`);
  renderStats();
}

// keep old name for backward compat
function toggleSub_item(qid,sid){toggleSub1(qid,sid);}

function delSub1(qid,sid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  q.subtasks=(q.subtasks||[]).filter(s=>String(s.id)!==String(sid));
  saveAll();
  // If no subtasks left, remove the sub-wrap entirely
  if(q.subtasks.length===0){
    const qwrap=document.querySelector(`.q-wrap[data-id="${qid}"]`);
    if(qwrap){const sw=qwrap.querySelector('.sub-wrap');if(sw)sw.remove();}
  } else {
    rebuildSubWrap(qid);
  }
  renderStats();
}

// keep old name for backward compat
function delSubtask(qid,sid){delSub1(qid,sid);}

function delSub2(qid,sid,xid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  s.subsubs=(s.subsubs||[]).filter(x=>String(x.id)!==String(xid));
  saveAll();rebuildSubWrap(qid);renderStats();
}

function nestQuestIntoTask(draggedId, targetId, soloOnly){
  pushUndo();
  const day=getDay(S.currentDate);
  const dragged=day.quests.find(q=>String(q.id)===String(draggedId));
  const target=day.quests.find(q=>String(q.id)===String(targetId));
  if(!dragged||!target||dragged===target)return;

  // Build the new subtask from the dragged quest
  const newSub={
    id:uid(),
    text:dragged.text,
    pri:dragged.pri||'normal',
    done:dragged.completed||false,
    subsubs:[]
  };

  if(!soloOnly){
    // Full stack: dragged quest's subtasks become sub-subtasks
    (dragged.subtasks||[]).forEach(s=>{
      newSub.subsubs.push({
        id:uid(),
        text:s.text,
        pri:s.pri||'normal',
        done:s.done||false
      });
    });
  }

  // Add as subtask of target
  if(!target.subtasks)target.subtasks=[];
  target.subtasks.push(newSub);

  // Remove dragged quest from day
  day.quests=day.quests.filter(q=>String(q.id)!==String(draggedId));
  day.order=(day.order||[]).filter(id=>String(id)!==String(draggedId));

  // Auto-open subtasks on target
  S.subShowing[targetId]=true;

  saveAll();render();
  showNotif(soloOnly?'NESTED (ROW ONLY)':'NESTED INTO TASK');
}

function dupeQ(qid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const newQ={
    ...q,
    id:uid(),
    completed:false,
    text:q.text+' (copy)',
    subtasks:(q.subtasks||[]).map(s=>({
      ...s,
      id:uid(),
      done:false,
      subsubs:(s.subsubs||[]).map(x=>({...x,id:uid(),done:false}))
    }))
  };
  // Insert right after the original
  const idx=day.quests.findIndex(q=>String(q.id)===String(qid));
  day.quests.splice(idx+1,0,newQ);
  const oidx=(day.order||[]).findIndex(id=>String(id)===String(qid));
  if(oidx>=0)day.order.splice(oidx+1,0,newQ.id);
  else day.order.push(newQ.id);
  saveAll();render();showNotif('QUEST DUPLICATED');
}

function dupeSub1(qid,sid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const idx=(q.subtasks||[]).findIndex(s=>String(s.id)===String(sid));
  if(idx<0)return;
  const s=q.subtasks[idx];
  const newS={
    ...s,
    id:uid(),
    done:false,
    text:s.text+' (copy)',
    subsubs:(s.subsubs||[]).map(x=>({...x,id:uid(),done:false}))
  };
  q.subtasks.splice(idx+1,0,newS);
  // Auto-show subsubs on the copy if it has any
  if(newS.subsubs&&newS.subsubs.length>0) S.ssShowing[newS.id]=true;
  saveAll();rebuildSubWrap(qid);showNotif('SUBTASK DUPLICATED');
}

function dupeSub2(qid,sid,xid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const s=(q.subtasks||[]).find(s=>String(s.id)===String(sid));
  if(!s)return;
  const idx=(s.subsubs||[]).findIndex(x=>String(x.id)===String(xid));
  if(idx<0)return;
  const x=s.subsubs[idx];
  const newX={...x,id:uid(),done:false,text:x.text+' (copy)'};
  s.subsubs.splice(idx+1,0,newX);
  saveAll();rebuildSubWrap(qid);showNotif('SUBTASK DUPLICATED');
}

function setQuestPri(qid,pri){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  q.pri=pri;saveAll();renderMain();
}

// â”€â”€ Generic subtask drag (works for both levels) â”€â”€
function setupSubDragGeneric(listEl, qid, depth, parentSid){
  listEl.querySelectorAll(':scope > .sub-item').forEach(item=>{
    const handle=item.querySelector('.sub-dh');
    if(!handle)return;
    let sdState=null;

    function subStart(clientY){
      const rect=item.getBoundingClientRect();
      const clone=item.cloneNode(true);
      clone.style.cssText=`position:fixed;top:${rect.top}px;left:${rect.left}px;width:${rect.width}px;z-index:999;opacity:0.7;pointer-events:none;box-shadow:0 2px 16px rgba(0,255,136,.3);border-radius:3px`;
      document.body.appendChild(clone);
      item.style.opacity='0.15';
      sdState={item,clone,startY:clientY,startTop:rect.top,nestTask:null,nestSub:null};
    }

    function subMove(clientY){
      if(!sdState)return;
      const d=clientY-sdState.startY;
      sdState.clone.style.top=(sdState.startTop+d)+'px';
      const mid=sdState.startTop+d+sdState.clone.offsetHeight/2;
      const cloneRect=sdState.clone.getBoundingClientRect();
      const midX=cloneRect.left+cloneRect.width/2;

      // Clear previous highlights
      document.querySelectorAll('.qi-row.sub-nest-target').forEach(r=>r.classList.remove('sub-nest-target'));
      document.querySelectorAll('.sub-item.sub-nest-target').forEach(r=>r.classList.remove('sub-nest-target'));
      sdState.nestTask=null;
      sdState.nestSub=null;

      // Check if hovering a task row (â†’ become subtask of that task)
      let overTask=false;
      document.querySelectorAll('.qi-row').forEach(qrow=>{
        const r=qrow.getBoundingClientRect();
        const over=midX>=r.left&&midX<=r.right&&mid>=r.top&&mid<=r.bottom;
        if(over){
          const wrap=qrow.closest('.q-wrap');
          const targetQid=wrap?wrap.dataset.id:null;
          if(targetQid&&targetQid!==qid){
            qrow.classList.add('sub-nest-target');
            sdState.nestTask=targetQid;
            overTask=true;
          }
        }
      });

      if(overTask)return;

      // Check if hovering a sibling sub-item at depth 1 (â†’ become sub-subtask)
      if(depth===1){
        document.querySelectorAll('.sub-list[data-depth="1"] > .sub-item').forEach(si=>{
          if(si===item)return;
          const r=si.querySelector('.sub-txt')||si;
          const br=si.getBoundingClientRect();
          const over=midX>=br.left&&midX<=br.right&&mid>=br.top&&mid<=br.bottom;
          if(over){
            si.classList.add('sub-nest-target');
            sdState.nestSub=si.dataset.sid;
          }
        });
        if(sdState.nestSub)return;
      }

      // Default: reorder within list
      const sibs=[...listEl.querySelectorAll(':scope > .sub-item')].filter(el=>el!==item);
      let before=null;
      for(const sib of sibs){const r=sib.getBoundingClientRect();if(mid<r.top+r.height/2){before=sib;break;}}
      if(before)listEl.insertBefore(item,before);else listEl.appendChild(item);
    }

    function subEnd(){
      if(!sdState)return;
      sdState.clone.remove();
      item.style.opacity='';
      document.querySelectorAll('.qi-row.sub-nest-target').forEach(r=>r.classList.remove('sub-nest-target'));
      document.querySelectorAll('.sub-item.sub-nest-target').forEach(r=>r.classList.remove('sub-nest-target'));

      const sid=item.dataset.sid;

      if(sdState.nestTask){
        // Move subtask to become a subtask of another task
        nestSubIntoTask(qid, sid, depth, parentSid, sdState.nestTask);
      } else if(sdState.nestSub&&depth===1){
        // Move subtask to become a sub-subtask of a sibling subtask
        nestSubIntoSub(qid, sid, sdState.nestSub);
      } else {
        // Save reordered list
        const day=getDay(S.currentDate);
        const q=day.quests.find(q=>String(q.id)===String(qid));
        if(q){
          if(depth===1){
            const order=[...listEl.querySelectorAll(':scope > .sub-item')].map(el=>el.dataset.sid);
            q.subtasks.sort((a,b)=>order.indexOf(String(a.id))-order.indexOf(String(b.id)));
          } else if(parentSid){
            const s=(q.subtasks||[]).find(s=>String(s.id)===String(parentSid));
            if(s){
              const order=[...listEl.querySelectorAll(':scope > .sub-item')].map(el=>el.dataset.sid);
              s.subsubs.sort((a,b)=>order.indexOf(String(a.id))-order.indexOf(String(b.id)));
            }
          }
          saveAll();
        }
      }
      sdState=null;
    }

    handle.addEventListener('mousedown',e=>{
      e.preventDefault();
      subStart(e.clientY);
      function mm(ev){subMove(ev.clientY);}
      function mu(){subEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);}
      document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
    });

    handle.addEventListener('touchstart',e=>{
      e.preventDefault();
      subStart(e.touches[0].clientY);
      function tm(ev){ev.preventDefault();subMove(ev.touches[0].clientY);}
      function tu(){subEnd();document.removeEventListener('touchmove',tm);document.removeEventListener('touchend',tu);}
      document.addEventListener('touchmove',tm,{passive:false});
      document.addEventListener('touchend',tu);
    },{passive:false});
  });
}

// Move a subtask/sub-subtask to become a subtask of a different task
function nestSubIntoTask(fromQid, sid, depth, parentSid, toQid){
  pushUndo();
  const day=getDay(S.currentDate);
  const fromQ=day.quests.find(q=>String(q.id)===String(fromQid));
  const toQ=day.quests.find(q=>String(q.id)===String(toQid));
  if(!fromQ||!toQ)return;

  let subData=null;
  if(depth===1){
    subData=fromQ.subtasks.find(s=>String(s.id)===String(sid));
    if(!subData)return;
    fromQ.subtasks=fromQ.subtasks.filter(s=>String(s.id)!==String(sid));
  } else {
    const parent=(fromQ.subtasks||[]).find(s=>String(s.id)===String(parentSid));
    if(!parent)return;
    subData=parent.subsubs.find(x=>String(x.id)===String(sid));
    if(!subData)return;
    parent.subsubs=parent.subsubs.filter(x=>String(x.id)!==String(sid));
  }

  // Add as new subtask with fresh id, carry sub-subtasks
  const newSub={
    id:uid(),
    text:subData.text,
    pri:subData.pri||'normal',
    done:subData.done||false,
    subsubs:(subData.subsubs||[]).map(x=>({...x,id:uid()}))
  };
  if(!toQ.subtasks)toQ.subtasks=[];
  toQ.subtasks.push(newSub);
  S.subShowing[toQid]=true;
  saveAll();render();
  showNotif('MOVED TO TASK');
}

// Move a subtask to become a sub-subtask of a sibling subtask
function nestSubIntoSub(qid, sid, targetSid){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  const subData=q.subtasks.find(s=>String(s.id)===String(sid));
  const targetSub=q.subtasks.find(s=>String(s.id)===String(targetSid));
  if(!subData||!targetSub||subData===targetSub)return;

  // Remove from subtasks
  q.subtasks=q.subtasks.filter(s=>String(s.id)!==String(sid));

  // Add as sub-subtask of target (sub-subtasks can't have their own children so flatten)
  if(!targetSub.subsubs)targetSub.subsubs=[];
  targetSub.subsubs.push({
    id:uid(),
    text:subData.text,
    pri:subData.pri||'normal',
    done:subData.done||false
  });
  // If it had subsubs, add those too as additional sub-subtasks
  (subData.subsubs||[]).forEach(x=>{
    targetSub.subsubs.push({...x,id:uid()});
  });

  S.ssShowing[targetSid]=true;
  saveAll();rebuildSubWrap(qid);
  showNotif('NESTED INTO SUBTASK');
}


let subDragState=null;

function setupDragHandle(rowEl,q){
  const handle=rowEl.querySelector('.dh');
  const handleSolo=rowEl.querySelector('.dh-solo');
  if(!handle&&!handleSolo)return;
  const wrap=rowEl.closest('.q-wrap');
  if(!wrap)return;

  function start(clientY, dragSubsOnly){
    const container=wrap.parentNode;
    if(!container)return;
    const rect=wrap.getBoundingClientRect();
    // Full stack: clone whole wrap. Solo: clone just the qi-row
    const cloneEl=dragSubsOnly?rowEl.cloneNode(true):wrap.cloneNode(true);
    cloneEl.style.cssText=`position:fixed;top:${rect.top}px;left:${rect.left}px;width:${rect.width}px;z-index:999;opacity:0.7;pointer-events:none;box-shadow:0 4px 24px rgba(0,170,255,.35);border-radius:4px`;
    document.body.appendChild(cloneEl);
    wrap.style.opacity='0.15';
    dragState={id:String(q.id),fromCat:q.cat,wrap,clone:cloneEl,container,startY:clientY,startTop:rect.top,nestTarget:null,dragSubsOnly:!!dragSubsOnly};
    document.querySelectorAll('.drop-zone').forEach(dz=>{
      if(dz.dataset.dropCat!==q.cat)dz.classList.add('active-drop');
    });
  }

  function move(clientY){
    if(!dragState)return;
    const delta=clientY-dragState.startY;
    dragState.clone.style.top=(dragState.startTop+delta)+'px';

    const cloneRect=dragState.clone.getBoundingClientRect();
    const midX=cloneRect.left+cloneRect.width/2;
    const midY=cloneRect.top+cloneRect.height/2;

    // Highlight target category section (cross-cat drop)
    let overDiffCat=false;
    document.querySelectorAll('.cat-sec').forEach(sec=>{
      const r=sec.getBoundingClientRect();
      const over=midX>=r.left&&midX<=r.right&&midY>=r.top&&midY<=r.bottom;
      const isSame=sec.dataset.cat===dragState.fromCat;
      sec.style.outline=(over&&!isSame)?'2px dashed var(--accent)':'';
      const h=sec.querySelector('.cat-hdr');
      if(h)h.style.background=(over&&!isSame)?'rgba(0,212,255,0.05)':'';
      if(over&&!isSame)overDiffCat=true;
    });

    // Highlight task-drop target (nest into another task)
    dragState.nestTarget=null;
    document.querySelectorAll('.q-wrap').forEach(qw=>{
      const qid=qw.dataset.id;
      if(qid===dragState.id)return; // skip self
      const r=qw.querySelector('.qi-row').getBoundingClientRect();
      const over=midX>=r.left&&midX<=r.right&&midY>=r.top&&midY<=r.bottom;
      qw.querySelector('.qi-row').style.outline=over?'2px solid var(--green)':'';
      if(over)dragState.nestTarget=qid;
    });

    if(overDiffCat||dragState.nestTarget)return; // don't reorder while hovering a nest target

    // Reorder within same container
    const container=dragState.container;
    const siblings=[...container.querySelectorAll('.q-wrap')].filter(el=>el!==dragState.wrap);
    const mid=dragState.startTop+delta+dragState.clone.offsetHeight/2;
    let insertBefore=null;
    for(const sib of siblings){
      const r=sib.getBoundingClientRect();
      if(mid<r.top+r.height/2){insertBefore=sib;break}
    }
    if(insertBefore){
      container.insertBefore(dragState.wrap,insertBefore);
    } else {
      const nonWraps=[...container.children].filter(el=>!el.classList.contains('q-wrap'));
      if(nonWraps.length)container.insertBefore(dragState.wrap,nonWraps[0]);
      else container.appendChild(dragState.wrap);
    }
  }

  function end(){
    if(!dragState)return;
    const cloneRect=dragState.clone.getBoundingClientRect();
    const cloneMidX=cloneRect.left+cloneRect.width/2;
    const cloneMidY=cloneRect.top+cloneRect.height/2;
    const nestTarget=dragState.nestTarget;

    dragState.clone.remove();
    dragState.wrap.style.opacity='';
    document.querySelectorAll('.drop-zone').forEach(dz=>dz.classList.remove('active-drop','over'));
    document.querySelectorAll('.cat-sec').forEach(s=>{
      s.style.outline='';
      const h=s.querySelector('.cat-hdr');
      if(h)h.style.background='';
    });
    document.querySelectorAll('.qi-row').forEach(r=>r.style.outline='');

    // Priority 1: nest into another task
    if(nestTarget){
      nestQuestIntoTask(dragState.id, nestTarget, dragState.dragSubsOnly);
      dragState=null;
      return;
    }

    // Priority 2: cross-category drop
    let droppedOnCat=null;
    document.querySelectorAll('.cat-sec').forEach(sec=>{
      if(sec.dataset.cat===dragState.fromCat)return;
      const r=sec.getBoundingClientRect();
      if(cloneMidX>=r.left&&cloneMidX<=r.right&&cloneMidY>=r.top&&cloneMidY<=r.bottom){
        droppedOnCat=sec.dataset.cat;
      }
    });

    if(droppedOnCat){
      moveQuestToCat(dragState.id, droppedOnCat);
    } else {
      saveOrderFromDOM(dragState.fromCat);
    }
    dragState=null;
  }

  function attachListeners(hdl, solo){
    hdl.addEventListener('mousedown',e=>{
      e.preventDefault();
      start(e.clientY, solo);
      const mm=ev=>{move(ev.clientY)};
      const mu=()=>{end();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu)};
      document.addEventListener('mousemove',mm);
      document.addEventListener('mouseup',mu);
    });
    hdl.addEventListener('touchstart',e=>{
      e.preventDefault();
      start(e.touches[0].clientY, solo);
      const tm=ev=>{ev.preventDefault();move(ev.touches[0].clientY)};
      const tu=()=>{end();document.removeEventListener('touchmove',tm);document.removeEventListener('touchend',tu)};
      document.addEventListener('touchmove',tm,{passive:false});
      document.addEventListener('touchend',tu);
    },{passive:false});
  }

  if(handle)attachListeners(handle, false);         // full stack drag
  if(handleSolo)attachListeners(handleSolo, true);  // row-only drag
}

function setupDropZone(dz,toCat){
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
  dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz.addEventListener('drop',e=>{
    e.preventDefault();
    dz.classList.remove('over');
    if(dragState&&dragState.fromCat!==toCat){
      moveQuestToCat(dragState.id,toCat);
    }
  });

  // touch drop: check on touchend
  dz.addEventListener('touchend',e=>{
    if(!dragState||dragState.fromCat===toCat)return;
    const touch=e.changedTouches[0];
    const el=document.elementFromPoint(touch.clientX,touch.clientY);
    if(el&&el.closest('.drop-zone')===dz){
      moveQuestToCat(dragState.id,toCat);
    }
  });
}

function setupContainerDrop(container,toCat){
  container.addEventListener('dragover',e=>{
    if(dragState&&dragState.fromCat!==toCat){e.preventDefault()}
  });
  container.addEventListener('drop',e=>{
    if(dragState&&dragState.fromCat!==toCat){
      e.preventDefault();
      moveQuestToCat(dragState.id,toCat);
    }
  });
}

function moveQuestToCat(qid,toCat){
  pushUndo();
  const day=getDay(S.currentDate);
  const q=day.quests.find(q=>String(q.id)===String(qid));
  if(!q)return;
  q.cat=toCat;
  saveAll();
  render();
  showNotif(`MOVED TO ${toCat}`);
}

function saveOrderFromDOM(cat){
  pushUndo();
  const body=document.getElementById('cbody-'+CSS.escape(cat));
  if(!body)return;
  const wraps=[...body.querySelectorAll('.q-wrap')];
  const catOrder=wraps.map(w=>w.dataset.id);
  const day=getDay(S.currentDate);
  const others=(day.order||[]).filter(id=>{
    const q=day.quests.find(q=>String(q.id)===String(id));
    return q&&q.cat!==cat;
  });
  day.order=[...catOrder,...others];
  saveAll();
}

function toggleSec(hdr){hdr.closest('.cat-sec').classList.toggle('collapsed')}

// â”€â”€â”€ CATEGORIES â”€â”€â”€
function openCatModal(){renderCatModal();document.getElementById('catMo').classList.add('open')}
function renderCatModal(){
  const list=document.getElementById('catList');
  list.innerHTML='';
  S.cats.forEach(cat=>{
    const color=S.catColors[cat]||'#00d4ff';
    const row=document.createElement('div');
    row.className='cl-item';
    row.innerHTML=`<div class="cl-swatch" style="background:${color}" onclick="pickCatColor('${esc(cat)}')"></div><input class="cl-name-inp" value="${cat}" data-orig="${cat}" onblur="renameCat(this)" onkeydown="if(event.key==='Enter')this.blur()"/><button class="cl-rem" onclick="removeCat('${esc(cat)}')">âœ•</button>`;
    list.appendChild(row);
  });
  const cp=document.getElementById('cpRow');
  cp.innerHTML=`<div class="cp-label">COLOR FOR NEW CATEGORY</div>`;
  COLORS.forEach(c=>{
    const sw=document.createElement('div');
    sw.className='cpsw'+(S.newCatColor===c?' picked':'');
    sw.style.background=c;
    sw.onclick=()=>{S.newCatColor=c;renderCatModal()};
    cp.appendChild(sw);
  });
}
function renameCat(inp){
  const orig=inp.dataset.orig;
  const newName=inp.value.trim().toUpperCase();
  if(!newName||newName===orig)return;
  if(S.cats.includes(newName)){showNotif('NAME ALREADY EXISTS');inp.value=orig;return;}
  pushUndo();
  // Rename in cats array
  const idx=S.cats.indexOf(orig);
  if(idx===-1)return;
  S.cats[idx]=newName;
  // Rename catColors
  S.catColors[newName]=S.catColors[orig];
  delete S.catColors[orig];
  // Rename all quests across all days
  Object.values(dayData).forEach(d=>{
    (d.quests||[]).forEach(q=>{if(q.cat===orig)q.cat=newName;});
  });
  // Update S references
  if(S.tab===orig)S.tab=newName;
  if(S.newTopCat===orig)S.newTopCat=newName;
  inp.dataset.orig=newName;
  saveAll();render();showNotif('CATEGORY RENAMED');
}

function addCat(){
  pushUndo();
  const inp=document.getElementById('ncInp');
  const name=inp.value.trim().toUpperCase();
  if(!name||S.cats.includes(name))return;
  S.cats.push(name);
  S.catColors[name]=S.newCatColor;
  S.newPri[name]='normal';
  inp.value='';
  saveAll();renderCatModal();showNotif('CATEGORY ADDED');
}
function removeCat(cat){
  pushUndo();
  if(S.cats.length<=1)return;
  S.cats=S.cats.filter(c=>c!==cat);
  if(S.tab===cat)S.tab='ALL';
  if(S.newTopCat===cat)S.newTopCat=S.cats[0];
  saveAll();renderCatModal();
}

// â”€â”€â”€ COMPLETE OVERLAY â”€â”€â”€
function showCompleteOverlay(sub){
  showNotif('âš¡ QUEST COMPLETE â€” '+(sub||'+XP EARNED'));
}

// â”€â”€â”€ UTILS â”€â”€â”€
function doFlash(){const e=document.getElementById('lflash');e.classList.add('show');setTimeout(()=>e.classList.remove('show'),100)}
let notifTimer = null;
function showNotif(msg){
  const e=document.getElementById('notif');
  const inner=document.getElementById('notifInner');
  inner.textContent=msg;
  e.classList.remove('hide');
  e.classList.add('show');
  clearTimeout(notifTimer);
  notifTimer=setTimeout(()=>{
    e.classList.add('hide');
    setTimeout(()=>{e.classList.remove('show','hide');},400);
  },2000);
}

// â”€â”€â”€ PLAYER NAME â”€â”€â”€
function loadPlayerName(){
  const name=localStorage.getItem('sl3_player')||'';
  const el=document.getElementById('playerName');
  if(el)el.textContent=name||'â€”';
}
function startEditName(){
  const span=document.getElementById('playerName');
  const inp=document.getElementById('playerNameInput');
  if(!span||!inp)return;
  inp.value=span.textContent==='â€”'?'':span.textContent;
  span.style.display='none';
  inp.style.display='inline-block';
  inp.focus();inp.select();
}
function savePlayerName(){
  const span=document.getElementById('playerName');
  const inp=document.getElementById('playerNameInput');
  if(!span||!inp)return;
  const name=inp.value.trim().toUpperCase();
  span.textContent=name||'â€”';
  span.style.display='inline-block';
  inp.style.display='none';
  localStorage.setItem('sl3_player',name);
  fbSave('data','player',name);
}

// â”€â”€â”€ ANIMATED BACKGROUND â”€â”€â”€
(function(){
  const canvas = document.getElementById('bgCanvas');
  const ctx = canvas.getContext('2d');
  let W, H, t = 0;

  function resize(){
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

// â”€â”€â”€ BANNER CIRCUIT ANIMATION â”€â”€â”€
(function(){
  const bc = document.getElementById('bannerCanvas');
  if(!bc) return;
  const bx = bc.getContext('2d');
  let bW, bH, bt=0;
  function bResize(){bW=bc.width=bc.offsetWidth;bH=bc.height=bc.offsetHeight;}
  bResize();
  window.addEventListener('resize',bResize);

  // Generate circuit nodes
  const nodes=[];
  for(let i=0;i<18;i++) nodes.push({x:Math.random(),speed:0.0002+Math.random()*0.0003,phase:Math.random()*Math.PI*2});

  function bDraw(){
    bx.clearRect(0,0,bW,bH);
    bt+=0.012;

    // Moving horizontal circuit lines
    for(let i=0;i<4;i++){
      const y=bH*(0.2+i*0.2);
      const alpha=0.12+0.06*Math.sin(bt+i);
      bx.strokeStyle=`rgba(0,200,255,${alpha})`;
      bx.lineWidth=0.5;
      bx.beginPath();
      bx.moveTo(0,y);
      bx.lineTo(bW,y);
      bx.stroke();
    }

    // Moving circuit dots/nodes
    nodes.forEach((n,i)=>{
      n.x=(n.x+n.speed)%1.1;
      if(n.x>1.05) n.x=-0.05;
      const x=n.x*bW;
      const y=bH*(0.15+((i%4)*0.2));
      const a=0.3+0.3*Math.sin(bt*2+n.phase);
      bx.fillStyle=`rgba(0,220,255,${a})`;
      bx.beginPath();
      bx.arc(x,y,1.5,0,Math.PI*2);
      bx.fill();

      // Occasional vertical ticks
      if(i%3===0){
        bx.strokeStyle=`rgba(0,200,255,${a*0.5})`;
        bx.lineWidth=0.5;
        bx.beginPath();
        bx.moveTo(x,y-4);
        bx.lineTo(x,y+4);
        bx.stroke();
      }
    });

    // Scan line sweep
    const scanX=((bt*0.08)%1.2-0.1)*bW;
    const sg=bx.createLinearGradient(scanX-20,0,scanX+20,0);
    sg.addColorStop(0,'rgba(0,200,255,0)');
    sg.addColorStop(0.5,'rgba(0,200,255,0.12)');
    sg.addColorStop(1,'rgba(0,200,255,0)');
    bx.fillStyle=sg;
    bx.fillRect(scanX-20,0,40,bH);

    requestAnimationFrame(bDraw);
  }
  bDraw();
})();

  // Energy orbs that drift slowly
  const orbs = Array.from({length:5}, (_, i) => ({
    x: Math.random(), y: Math.random(),
    vx: (Math.random()-.5)*0.0003,
    vy: (Math.random()-.5)*0.0003,
    r: 0.15 + Math.random()*0.25,
    phase: Math.random()*Math.PI*2,
    hue: Math.random()<0.7 ? 195 : 230,
  }));

  // Crack/lightning lines
  function makeCrack(x1,y1,depth){
    const segs = [];
    let x=x1, y=y1;
    const steps = 4+Math.floor(Math.random()*5);
    for(let i=0;i<steps;i++){
      const angle = (Math.random()-.5)*1.2;
      const len = 20+Math.random()*60;
      const nx = x + Math.cos(angle)*len;
      const ny = y + Math.sin(angle)*len*0.4;
      segs.push({x1:x,y1:y,x2:nx,y2:ny});
      x=nx; y=ny;
      if(depth>0 && Math.random()<0.3){
        segs.push(...makeCrack(x,y,depth-1));
      }
    }
    return segs;
  }

  const cracks = Array.from({length:8}, ()=>({
    segs: makeCrack(Math.random()*800, Math.random()*600, 1),
    alpha: 0,
    maxAlpha: 0.1+Math.random()*0.14,
    phase: Math.random()*Math.PI*2,
    speed: 0.005+Math.random()*0.008,
    x: Math.random(),
    y: 0.2+Math.random()*0.6,
  }));

  function draw(){
    requestAnimationFrame(draw);
    t += 0.008;

    // Deep dark base
    ctx.fillStyle = '#010208';
    ctx.fillRect(0,0,W,H);

    // â”€â”€ Moving energy orbs (blue/indigo glow pools) â”€â”€
    for(const orb of orbs){
      orb.x += orb.vx;
      orb.y += orb.vy;
      if(orb.x<-orb.r)orb.x=1+orb.r;
      if(orb.x>1+orb.r)orb.x=-orb.r;
      if(orb.y<-orb.r)orb.y=1+orb.r;
      if(orb.y>1+orb.r)orb.y=-orb.r;

      const pulse = 0.6+0.4*Math.sin(t*1.1+orb.phase);
      const grd = ctx.createRadialGradient(
        orb.x*W, orb.y*H, 0,
        orb.x*W, orb.y*H, orb.r*Math.max(W,H)
      );
      const a = (0.18+0.08*pulse).toFixed(3);
      const a2 = (0.07+0.03*pulse).toFixed(3);
      grd.addColorStop(0, `hsla(${orb.hue},100%,55%,${a})`);
      grd.addColorStop(0.5, `hsla(${orb.hue},90%,40%,${a2})`);
      grd.addColorStop(1, `hsla(${orb.hue},80%,30%,0)`);
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,W,H);
    }

    // â”€â”€ Fine grid â”€â”€
    ctx.save();
    const gridA = 0.045+0.015*Math.sin(t*0.4);
    ctx.strokeStyle = `rgba(0,180,255,${gridA})`;
    ctx.lineWidth = 0.5;
    const gSize = 38;
    // slight slow drift
    const drift = (t*4)%gSize;
    for(let x=(-drift)%gSize; x<W+gSize; x+=gSize){
      ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    }
    for(let y=(-drift*0.5)%gSize; y<H+gSize; y+=gSize){
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
    }
    ctx.restore();

    // â”€â”€ Crack / lightning veins â”€â”€
    for(const crack of cracks){
      crack.alpha = crack.maxAlpha*(0.5+0.5*Math.sin(t*crack.speed*130+crack.phase));
      if(crack.alpha < 0.005) continue;
      ctx.save();
      ctx.translate(crack.x*W-400, crack.y*H-300);
      ctx.strokeStyle = `rgba(0,220,255,${crack.alpha})`;
      ctx.lineWidth = 0.8;
      ctx.shadowColor = 'rgba(0,220,255,0.7)';
      ctx.shadowBlur = 6;
      for(const seg of crack.segs){
        ctx.beginPath();
        ctx.moveTo(seg.x1,seg.y1);
        ctx.lineTo(seg.x2,seg.y2);
        ctx.stroke();
      }
      ctx.restore();
    }

    // â”€â”€ Horizontal scan line sweep â”€â”€
    const scanY = ((t*0.12)%1.4-0.2)*H;
    const scanGrd = ctx.createLinearGradient(0,scanY-40,0,scanY+40);
    scanGrd.addColorStop(0,'rgba(0,180,255,0)');
    scanGrd.addColorStop(0.5,'rgba(0,180,255,0.03)');
    scanGrd.addColorStop(1,'rgba(0,180,255,0)');
    ctx.fillStyle = scanGrd;
    ctx.fillRect(0,scanY-40,W,80);
  }

  draw();
})();

// â”€â”€â”€ SAVE PROFILE â”€â”€â”€
async function saveProfile(){
  showNotif('SAVING...');
  try {
    await Promise.all([
      fbSaveImmediate('data','days',dayData),
      fbSaveImmediate('data','cfg',{cats:S.cats,catColors:S.catColors}),
      fbSaveImmediate('data','player',localStorage.getItem('sl3_player')||''),
      fbSaveImmediate('data','ui',{subShowing:S.subShowing,subCollapsed:S.subCollapsed,ssShowing:S.ssShowing}),
    ]);
    showNotif('PROFILE SAVED âœ“');
  } catch(e){
    showNotif('SAVE FAILED âœ—');
    console.error(e);
  }
}

// â”€â”€â”€ COPY DATA FOR BACKUP â”€â”€â”€
function copyData(){
  const data = {
    sl3_days: localStorage.getItem('sl3_days'),
    sl3_cfg: localStorage.getItem('sl3_cfg'),
    sl3_ui: localStorage.getItem('sl3_ui'),
    sl3_player: localStorage.getItem('sl3_player')
  };
  const text = JSON.stringify(data);
  // Try clipboard API first
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{
      showNotif('DATA COPIED âœ“ PASTE TO CLAUDE');
    }).catch(()=>{
      // Fallback â€” show in a textarea they can copy manually
      showDataModal(text);
    });
  } else {
    showDataModal(text);
  }
}

function showDataModal(text){
  const mo = document.createElement('div');
  mo.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:10px';
  mo.innerHTML=`
    <div style="color:#00e5ff;font-family:Orbitron,monospace;font-size:12px;letter-spacing:2px;margin-bottom:8px">SELECT ALL & COPY THIS TEXT</div>
    <textarea style="width:100%;max-width:500px;height:200px;background:#010208;color:#00e5ff;border:1px solid #00e5ff;padding:10px;font-size:10px;border-radius:4px" readonly>${text}</textarea>
    <button onclick="this.parentElement.remove()" style="margin-top:10px;background:none;border:1px solid #00e5ff;color:#00e5ff;font-family:Orbitron,monospace;padding:10px 20px;border-radius:3px;cursor:pointer">CLOSE</button>
  `;
  document.body.appendChild(mo);
  // Auto select the text
  setTimeout(()=>mo.querySelector('textarea').select(), 100);
}

// â”€â”€â”€ EXPORT WITH DATA â”€â”€â”€
function exportWithData(){
  const keys=['sl3_days','sl3_cfg','sl3_ui','sl3_player'];
  const data={};
  keys.forEach(k=>{const v=localStorage.getItem(k);if(v)data[k]=v;});
  if(!Object.keys(data).length){showNotif('NO DATA TO EXPORT');return;}

  showNotif('PREPARING EXPORT...');

  fetch(window.location.href)
    .then(r=>r.text())
    .then(html=>doExport(html,data))
    .catch(()=>doExport(null,data));
}

function doExport(html,data){
  // If fetch failed or returned bad HTML, build from scratch using the script content
  if(!html||!html.includes('<!DOCTYPE')){
    // Get the actual script source from the page
    const scripts=document.querySelectorAll('script:not([id])');
    let scriptSrc='';
    scripts.forEach(s=>{if(s.textContent.length>1000)scriptSrc=s.textContent;});
    // Get full page HTML cleanly
    html='<!DOCTYPE html>\n<html lang="en">\n'+document.documentElement.innerHTML+'\n</html>';
  }

  // Strip any existing preload block
  html=html.replace(/<script id="sl3-preload">[\s\S]*?<\/script>\n?/g,'');

  // Replace the dayData initialisation line directly with the actual data
  if(data['sl3_days']){
    html=html.replace(
      "let dayData = JSON.parse(localStorage.getItem('sl3_days')||'{}');",
      "let dayData = "+data['sl3_days']+";"
    );
  }

  // Also inject the other keys via a preload script before </head>
  const sc='scr'+'ipt', close='</'+'script>';
  const entries=[];
  ['sl3_cfg','sl3_ui','sl3_player'].forEach(k=>{
    if(data[k]) entries.push('localStorage.setItem('+JSON.stringify(k)+','+JSON.stringify(data[k])+');');
  });
  if(entries.length){
    const preload='\n<'+sc+' id="sl3-preload">\n'+entries.join('\n')+'\n'+close+'\n';
    html=html.replace('</head>','</head>'+preload);
  }

  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.style.display='none';
  a.href=url;
  a.setAttribute('download','the-system-export.html');
  document.body.appendChild(a);
  a.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window}));
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
  showNotif('EXPORTED âœ“ CHECK DOWNLOADS');
}

// â”€â”€â”€ INIT WITH FIREBASE â”€â”€â”€
async function initApp(){
  showNotif('CONNECTING TO THE SYSTEM...');

  // First load from localStorage so app is immediately usable
  loadCfg();
  loadPlayerName();
  if(!S.newTopCat)S.newTopCat=S.cats[0];
  getDay(S.currentDate);
  render();

  // Then load from Firebase and override if data exists there
  try {
    const fb = await fbLoad();

    if(fb.days){
      dayData = fb.days;
      // Sync to localStorage
      localStorage.setItem('sl3_days', JSON.stringify(dayData));
    }
    if(fb.cfg){
      if(fb.cfg.cats) S.cats = fb.cfg.cats;
      if(fb.cfg.catColors) S.catColors = {...DEFAULT_COLORS,...fb.cfg.catColors};
      localStorage.setItem('sl3_cfg', JSON.stringify(fb.cfg));
    }
    if(fb.ui){
      if(fb.ui.subShowing) S.subShowing = fb.ui.subShowing;
      if(fb.ui.subCollapsed) S.subCollapsed = fb.ui.subCollapsed;
      if(fb.ui.ssShowing) S.ssShowing = fb.ui.ssShowing;
      localStorage.setItem('sl3_ui', JSON.stringify(fb.ui));
    }
    if(fb.player){
      // fb.player may be JSON-stringified, parse it safely
      let pname = fb.player;
      try { pname = JSON.parse(pname); } catch(e){}
      if(typeof pname !== 'string') pname = String(pname);
      localStorage.setItem('sl3_player', pname);
      loadPlayerName();
    }

    getDay(S.currentDate);
    render();
    fbLoaded = true; // NOW safe to save
    showNotif('SYSTEM ONLINE âœ“');
  } catch(e){
    console.warn('Firebase init error:', e);
    fbLoaded = true; // allow saves even in offline mode
    showNotif('OFFLINE MODE');
  }
}

initApp();


</script>
</body>
</html>
